<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tracker xAI Edition</title>
<meta name="theme-color" content="#0a0d14">
<style>
  :root {
    --bg: #0a0d14; --card: rgba(255,255,255,0.1); --ink: #e9edff; --muted: #96a0bb; --ring: #223056;
    --brand: #3b6cff; --brand2: #8b5cf6; --ok: #16a34a; --bad: #ef4444;
    --radius: clamp(12px, 3vw, 20px); --sm: clamp(10px, 2.5vw, 12px);
    --shadow: 0 8px 24px rgba(0,0,0,0.2);
    --glass: blur(20px) saturate(1.5);
  }
  @media (prefers-color-scheme: light) {
    :root { --bg: #f6f8ff; --card: rgba(255,255,255,0.8); --ink: #0d1230; --muted: #5c637a; --ring: #e5e9ff; }
  }
  * { box-sizing: border-box; transition: all 0.3s ease-out; }
  html, body { height: 100%; margin: 0; padding: 0; }
  body {
    color: var(--ink); font: 500 clamp(14px, 3.5vw, 16px)/1.5 'Inter', system-ui;
    background: radial-gradient(circle at top, color-mix(in srgb, var(--brand) 10%, var(--bg)), var(--bg));
    overflow: hidden; position: relative;
  }
  /* Fondo inmersivo con part√≠culas */
  body::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 50%); opacity: 0.3; animation: starsTwinkle 5s infinite; z-index: -1; }
  @keyframes starsTwinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.5; } }

  .app { height: 100dvh; display: grid; grid-template-columns: auto 1fr; overflow: hidden; }
  .sidebar { position: sticky; top: 0; height: 100dvh; padding: 20px; background: color-mix(in srgb, var(--bg) 90%, transparent); backdrop-filter: var(--glass); display: flex; flex-direction: column; gap: 16px; z-index: 10; }
  .logo { width: 48px; height: 48px; border-radius: var(--radius); background: linear-gradient(135deg, var(--brand), var(--brand2)); box-shadow: var(--shadow); }
  .nav { display: flex; flex-direction: column; gap: 8px; }
  .nav-btn { padding: 12px; border-radius: var(--radius); background: var(--card); color: var(--ink); text-align: left; box-shadow: var(--shadow); backdrop-filter: var(--glass); cursor: pointer; }
  .nav-btn.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; }

  .main { overflow-y: auto; padding: 20px; display: grid; gap: 20px; }
  .hero { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); backdrop-filter: var(--glass); text-align: center; }
  .teams { display: flex; justify-content: center; align-items: center; gap: 24px; }
  .crest { width: 96px; height: 96px; border-radius: var(--radius); box-shadow: var(--shadow); background: var(--bg); display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .crest img { max-width: 80%; max-height: 80%; object-fit: contain; }
  .vs { font-size: clamp(24px, 6vw, 32px); font-weight: 900; }
  .countdown { font-size: clamp(18px, 4vw, 24px); margin-top: 8px; color: var(--brand); }

  .section { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); backdrop-filter: var(--glass); }
  .chart-container { width: 100%; aspect-ratio: 1/1; max-height: 300px; margin: 0 auto; position: relative; }
  .timeline { display: flex; flex-direction: column; gap: 16px; }
  .timeline-item { border-left: 4px solid var(--brand); padding-left: 16px; position: relative; }
  .timeline-item::before { content: ''; position: absolute; left: -10px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--brand); }

  /* Responsive para m√≥viles */
  @media (max-width: 768px) {
    .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
    .sidebar { position: fixed; bottom: 0; left: 0; right: 0; height: auto; flex-direction: row; padding: 8px; justify-content: space-around; z-index: 20; }
    .nav { flex-direction: row; gap: 4px; width: 100%; }
    .nav-btn { flex: 1; text-align: center; padding: 8px; font-size: var(--sm); }
    .main { padding-bottom: 80px; }
    .teams { flex-direction: column; gap: 16px; }
    .crest { width: 72px; height: 72px; }
    .chart-container { aspect-ratio: 4/3; }
  }
  @media (max-width: 400px) {
    .nav-btn { font-size: 10px; padding: 6px; }
  }

  .hidden { display: none; }
  canvas.confetti { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 5; }
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Sidebar/Nav -->
  <nav class="sidebar">
    <div class="logo">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="var(--brand)"/><stop offset="1" stop-color="var(--brand2)"/></linearGradient></defs><path d="M8 10h48v16c0 18-24 28-24 28S8 44 8 26z" fill="url(#g)"/><circle cx="32" cy="28" r="7" fill="#fff" opacity=".15"/></svg>
    </div>
    <div class="nav">
      <button class="nav-btn active" data-tab="next">Siguiente</button>
      <button class="nav-btn" data-tab="past">Pasados</button>
      <button class="nav-btn" data-tab="live">En Vivo</button>
      <button class="nav-btn" data-tab="table">Clasificaci√≥n</button>
      <button class="nav-btn" data-tab="cal">Calendario</button>
      <button class="nav-btn" data-tab="teams">Equipos</button>
    </div>
    <button id="themeBtn" class="nav-btn" style="margin-top: auto;">üåó Tema</button>
    <button id="installBtn" class="nav-btn hidden">‚¨áÔ∏è Instalar</button>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <!-- Hero for Next Match -->
    <section id="tab-next" class="hero">
      <h2>Siguiente Partido</h2>
      <div class="teams">
        <div class="crest" id="homeCrest"></div>
        <div class="vs">vs</div>
        <div class="crest" id="awayCrest"></div>
      </div>
      <div id="whenText" class="countdown">‚Äî</div>
      <div id="compText" style="color: var(--muted);">‚Äî</div>
      <div id="statusBadges" style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;"></div>
      <!-- TV, Odds, News in sub-sections -->
      <div class="section" style="margin-top: 16px;">
        <h3>TV</h3>
        <div id="tvRow"></div>
      </div>
      <div class="section">
        <h3>Cuotas</h3>
        <div id="oddsBox" class="grid"></div>
      </div>
      <div class="section">
        <h3>Noticias</h3>
        <div id="newsList"></div>
      </div>
      <button id="notifyBtn">Recordarme</button>
      <button id="icsBtn">A√±adir al Calendario</button>
    </section>

    <!-- Other Tabs -->
    <section id="tab-past" class="section hidden">
      <h2>Partidos Pasados</h2>
      <div id="pastList"></div>
    </section>
    <section id="tab-live" class="section hidden">
      <h2>En Vivo</h2>
      <div id="liveList"></div>
    </section>
    <section id="tab-table" class="section hidden">
      <h2>Clasificaci√≥n</h2>
      <div class="chart-container">
        <svg id="radarChart" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
      <div id="tableUpdated" style="text-align: center; color: var(--muted);"></div>
    </section>
    <section id="tab-cal" class="section hidden">
      <h2>Calendario</h2>
      <div id="calWrap" class="timeline"></div>
    </section>
    <section id="tab-teams" class="section hidden">
      <h2>Equipos</h2>
      <input id="teamSearch" placeholder="Buscar equipo">
      <div id="leagueList" style="display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));"></div>
    </section>
  </main>

  <!-- Confetti Canvas -->
  <canvas id="confetti" class="confetti" width="0" height="0"></canvas>
</div>

<script>
const WORKER = "https://test.christiansanabria.workers.dev";
const BARCA_ID = "81";
const COUNTRY = "Spain"; const LANG = "es-ES", GL = "ES", CEID = "ES:es";

const state = { theme: localStorage.getItem("theme") || (matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light"), teamId: localStorage.getItem("teamId") || BARCA_ID, crestMap: {}, deferredPrompt: null };

const $ = (q, el = document) => el.querySelector(q);
const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));
setTheme(state.theme);
function setTheme(t) {
  state.theme = t; localStorage.setItem("theme", t); document.documentElement.setAttribute('data-theme', t);
}
$("#themeBtn").onclick = () => setTheme(state.theme === "light" ? "dark" : "light");

// Tabs
$$(".nav-btn").forEach(b => b.onclick = () => switchTab(b.dataset.tab));
function switchTab(name) {
  $$(".nav-btn").forEach(x => x.classList.toggle("active", x.dataset.tab === name));
  $$(".main > section").forEach(s => s.classList.toggle("hidden", s.id !== "tab-" + name));
  if (name === "next") loadNext(state.teamId);
  if (name === "past") loadPast();
  if (name === "live") loadLive();
  if (name === "table") loadStandings();
  if (name === "cal") loadCalendar();
  if (name === "teams") renderTeams();
}

// Helpers (mismo que original, abreviado por espacio)
function parts(iso) { const d = new Date(iso); return { d: d.toLocaleDateString(LANG, { weekday: "short", day: "2-digit", month: "short" }), t: d.toLocaleTimeString(LANG, { hour: "2-digit", minute: "2-digit" }) }; }
function badge(t) { const el = document.createElement("span"); el.textContent = t; el.style.padding = "4px 8px"; el.style.borderRadius = "999px"; el.style.background = "var(--ring)"; return el; }
async function ensureCrests() { /* mismo que original */ }
function crestEl(id, name) { /* mismo, pero con img loading="lazy" */ }

// Load functions reinventadas con nuevo UI
async function loadNext(teamId) {
  await ensureCrests();
  const data = await (await fetch(`${WORKER}/matches?team=${teamId}&status=SCHEDULED&country=${COUNTRY}&include_tv=1`)).json();
  const next = data.matches[0];
  if (!next) return;
  $("#homeCrest").innerHTML = ''; $("#homeCrest").append(crestEl(next.homeTeam.id, next.homeTeam.name));
  $("#awayCrest").innerHTML = ''; $("#awayCrest").append(crestEl(next.awayTeam.id, next.awayTeam.name));
  $("#whenText").textContent = parts(next.utcDate).d + ' ¬∑ ' + parts(next.utcDate).t;
  $("#compText").textContent = next.competition.name;
  // A√±ade countdown animado
  setInterval(() => {
    const timeLeft = new Date(next.utcDate) - Date.now();
    $("#whenText").textContent = Math.floor(timeLeft / 3600000) + 'h ' + Math.floor((timeLeft % 3600000) / 60000) + 'm';
  }, 60000);
  // TV, Odds, News (similar, pero en nuevo layout)
}

// Para clasificaci√≥n: Radar chart SVG como visual aid
async function loadStandings() {
  const data = await (await fetch(`${WORKER}/standings`)).json();
  const rows = data.standings[0].table.slice(0, 5); // Top 5 for simplicity
  const svg = $("#radarChart"); svg.innerHTML = '';
  const centerX = 200, centerY = 200, radius = 150;
  rows.forEach((r, i) => {
    const angle = (i / rows.length) * 2 * Math.PI;
    const x = centerX + Math.cos(angle) * (r.points / 100 * radius);
    const y = centerY + Math.sin(angle) * (r.points / 100 * radius);
    const path = svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg", "path"));
    path.setAttribute("d", `M${centerX},${centerY} L${x},${y}`);
    path.setAttribute("stroke", "var(--brand)"); path.setAttribute("stroke-width", 2);
    const text = svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg", "text"));
    text.setAttribute("x", x + 10); text.setAttribute("y", y); text.textContent = `${r.team.name} (${r.points})`;
  });
}

// Confetti for wins (idea loca)
function triggerConfetti() {
  const canvas = $("#confetti"); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const ctx = canvas.getContext("2d");
  // Simple confetti animation (particles falling)
  // (C√≥digo abreviado; en producci√≥n usa una lib ligera)
}

// Init y resto similar al original
(async () => { switchTab("next"); })();
</script>
</body>
</html>