<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tracker Modernizado</title>
<meta name="theme-color" content="#0a0d14">
<style>
  @font-face { font-family: 'Inter'; src: url('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2') format('woff2'); font-weight: 1 1000; font-style: normal; font-display: swap; }
  :root {
    --bg: linear-gradient(135deg, #f6f8ff, #e9edff); --card: #ffffff; --ink: #0d1230; --muted: #5c637a; --ring: #e5e9ff;
    --brand: #3b6cff; --brand2: #8b5cf6; --ok: #16a34a; --bad: #ef4444;
    --radius: clamp(16px, 4vw, 24px); --sm: clamp(12px, 3vw, 14px);
    --shadow-neu: 8px 8px 16px rgba(0,0,0,0.1), -8px -8px 16px rgba(255,255,255,0.5);
    --glass: blur(30px) saturate(1.8);
  }
  [data-theme="dark"] {
    --bg: linear-gradient(135deg, #0a0d14, #101523); --card: #0f1629; --ink: #e9edff; --muted: #96a0bb; --ring: #223056;
    --brand: #7da2ff; --brand2: #b892ff; --shadow-neu: 8px 8px 16px rgba(0,0,0,0.3), -8px -8px 16px rgba(255,255,255,0.05);
  }
  * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  html, body { height: 100%; }
  body {
    margin: 0; color: var(--ink); font: 500 clamp(16px, 4vw, 18px)/1.6 'Inter', system-ui;
    background: var(--bg); background-size: 200% 200%; animation: gradientFlow 15s ease infinite;
    overflow-x: hidden; position: relative;
  }
  @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  /* Part√≠culas sutiles en background */
  body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(59,108,255,0.1) 0%, transparent 70%); opacity: 0.5; animation: particles 20s infinite; pointer-events: none; }
  @keyframes particles { 0% { transform: translate(0, 0); } 100% { transform: translate(20px, 20px); } }
  .app { max-width: 560px; margin: 0 auto; min-height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; position: relative; }

  /* Header m√°s prominente con parallax */
  header { position: sticky; top: 0; z-index: 40; padding: var(--sm) 16px; backdrop-filter: var(--glass); background: color-mix(in oklab, var(--bg) 80%, transparent); transform: translateY(0); box-shadow: var(--shadow-neu); border-radius: 0 0 var(--radius) var(--radius); }
  .app.scrolled header { transform: translateY(-10px) scale(0.98); }
  .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .brand { display: flex; gap: 12px; align-items: center; }
  .logo { width: 50px; height: 50px; border-radius: var(--radius); box-shadow: var(--shadow-neu); background: linear-gradient(135deg, var(--brand), var(--brand2)); animation: logoGlow 2s infinite alternate; }
  @keyframes logoGlow { 0% { box-shadow: 0 0 10px var(--brand); } 100% { box-shadow: 0 0 20px var(--brand2); } }
  .logo:hover { transform: rotate(360deg); transition: transform 0.6s; }
  .logo svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
  .title { font-weight: 900; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }

  /* Tabs como segmented control con swipe effect */
  .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 8px; background: color-mix(in oklab, var(--card) 50%, transparent); border-radius: var(--radius); scroll-snap-type: x mandatory; }
  .pill { padding: 10px 16px; border-radius: var(--radius); background: var(--card); box-shadow: var(--shadow-neu); color: var(--ink); position: relative; scroll-snap-align: center; }
  .pill.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; box-shadow: 0 0 15px var(--brand); }
  .pill:hover { transform: scale(1.1); }

  /* Screen con slide-in animation */
  .screen { padding: 16px 16px 120px; display: grid; gap: 16px; animation: slideIn 0.6s ease-out; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: none; } }
  .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow-neu); padding: 16px; position: relative; overflow: hidden; }
  .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(var(--brand-rgb),0.1) 0%, transparent 70%); opacity: 0; transition: opacity 0.3s; }
  .card:hover::before { opacity: 1; }
  .card:hover { transform: translateY(-8px) rotate(1deg); }

  /* Match hero asim√©trico */
  .teams { display: flex; justify-content: space-around; align-items: center; gap: 20px; margin-top: 12px; }
  .club { text-align: center; transform: skew(-5deg); transition: transform 0.3s; }
  .club:hover { transform: skew(0) scale(1.1); }
  .crest { width: 80px; height: 80px; border-radius: var(--radius); box-shadow: var(--shadow-neu); background: var(--card); }
  .vs { font-size: 24px; font-weight: 900; color: var(--brand); text-shadow: 2px 2px 4px rgba(0,0,0,0.2); animation: vsPulse 1.5s infinite; }
  @keyframes vsPulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

  /* TV con ripple */
  .tv { padding: 10px 14px; border-radius: var(--radius); box-shadow: var(--shadow-neu); position: relative; overflow: hidden; }
  .tv:hover { background: color-mix(in oklab, var(--brand) 20%, var(--card)); }
  .tv-dot { animation: pulse 1s infinite; }

  /* News como carrusel con scroll snap */
  .news { display: flex; overflow-x: auto; gap: 12px; scroll-snap-type: x mandatory; padding-bottom: 10px; }
  .news .item { flex: 0 0 80%; scroll-snap-align: start; border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow-neu); min-width: 250px; }

  /* Standings con bar chart SVG */
  table { display: none; } /* Reemplazado por chart */
  .chart { display: flex; flex-direction: column; gap: 8px; }
  .chart-bar { height: 20px; background: linear-gradient(to right, var(--brand), var(--brand2)); border-radius: var(--radius); position: relative; }
  .chart-bar::after { content: attr(data-label); position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #fff; font-weight: bold; }

  /* Bottom nav como dock flotante */
  .bn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 60; display: flex; gap: 8px; background: var(--card); box-shadow: var(--shadow-neu); border-radius: var(--radius); padding: 10px; animation: dockFloat 2s infinite ease-in-out; }
  @keyframes dockFloat { 0% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } 100% { transform: translate(-50%, 0); } }
  .bn button { border-radius: var(--radius); padding: 12px; background: var(--card); box-shadow: var(--shadow-neu); }
  .bn button.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; }

  /* Loader spinner global */
  .loading-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid var(--ring); border-top: 4px solid var(--brand); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; z-index: 100; display: none; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading .loading-spinner { display: block; }

  /* Media queries para m√≥viles */
  @media (max-width: 400px) {
    .teams { flex-direction: column; }
    .bn { width: 90%; flex-wrap: wrap; justify-content: center; }
    .news { flex-direction: column; overflow-y: auto; height: 300px; }
  }

  .hidden { display: none !important; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) rotate(-5deg); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>
<div class="loading-spinner"></div>
<div class="app" id="app" data-theme="light">
  <!-- HEADER -->
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="var(--brand)"/><stop offset="1" stop-color="var(--brand2)"/></linearGradient></defs><path d="M8 10h48v16c0 18-24 28-24 28S8 44 8 26z" fill="url(#g)"/><circle cx="32" cy="28" r="7" fill="#fff" opacity=".15"/></svg>
        </div>
        <div><div class="title">Tracker 2.0</div><div class="tiny">Bar√ßa primero, ahora m√°s moderno.</div></div>
      </div>
      <div class="brand" style="gap:8px">
        <button id="themeBtn" class="pill" title="Tema">üåó</button>
        <button id="installBtn" class="pill hidden" title="Instalar">‚¨áÔ∏è</button>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Secciones">
      <button class="pill active" data-tab="next">Siguiente</button>
      <button class="pill" data-tab="past">Pasados</button>
      <button class="pill" data-tab="live">En vivo</button>
      <button class="pill" data-tab="table">Clasificaci√≥n</button>
      <button class="pill" data-tab="cal">Calendario</button>
      <button class="pill" data-tab="teams">Equipos</button>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="screen">
    <!-- NEXT con hero asim√©trico -->
    <section id="tab-next" class="card">
      <div class="kicker">Siguiente Partido √âpico</div>
      <div class="teams">
        <div class="club">
          <div class="crest" id="homeCrest"><div class="fallback">BAR</div></div>
          <div id="homeName" class="tiny">FC Barcelona</div>
        </div>
        <div class="vs">VS</div>
        <div class="club">
          <div class="crest" id="awayCrest"><div class="fallback">???</div></div>
          <div id="awayName" class="tiny">Cargando‚Ä¶</div>
        </div>
      </div>
      <div class="when" id="whenText">‚Äî</div>
      <div class="tiny" id="compText">‚Äî</div>
      <div class="badges" id="statusBadges"></div>

      <div class="divider"></div>
      <strong>TV en Vivo</strong>
      <div class="tv-logos" id="tvRow"><span class="tiny">Buscando canales‚Ä¶</span></div>

      <div class="divider"></div>
      <strong>Cuotas Actualizadas</strong>
      <div id="oddsBox" class="grid cols-3"></div>

      <div class="divider"></div>
      <strong>Noticias Calientes</strong>
      <div id="newsList" class="news"></div>

      <div class="divider"></div>
      <div class="row" style="gap:10px">
        <button class="pill" id="notifyBtn">Notif√≠came</button>
        <button class="pill active" id="icsBtn">Al Calendario</button>
      </div>
    </section>

    <!-- PAST -->
    <section id="tab-past" class="card hidden">
      <div class="kicker">Historia de Batallas</div>
      <div id="pastList" class="grid"></div>
    </section>

    <!-- LIVE -->
    <section id="tab-live" class="card hidden">
      <div class="kicker">Acci√≥n en Directo</div>
      <div id="liveList" class="grid"></div>
    </section>

    <!-- TABLE con chart -->
    <section id="tab-table" class="card hidden">
      <strong>Clasificaci√≥n Visual</strong>
      <div class="chart" id="chart"></div>
      <span class="tiny" id="tableUpdated">‚Äî</span>
    </section>

    <!-- CALENDAR -->
    <section id="tab-cal" class="card hidden">
      <strong>Calendario Futuro</strong>
      <div id="calWrap" class="grid"></div>
    </section>

    <!-- TEAMS -->
    <section id="tab-teams" class="card hidden">
      <strong>Elige tu Equipo</strong>
      <input id="teamSearch" placeholder="Busca en LaLiga" style="width:100%; padding:14px; border-radius:var(--radius); box-shadow:var(--shadow-neu); background:var(--card); color:var(--ink);">
      <div id="teamChips" class="badges"></div>
      <div class="divider"></div>
      <div id="leagueList" class="badges"></div>
    </section>
  </main>

  <!-- BOTTOM NAV -->
  <nav class="bn" aria-label="Navegaci√≥n">
    <button data-tab="next" class="active">‚ñ∂Ô∏è Siguiente</button>
    <button data-tab="past">‚èÆÔ∏è Pasados</button>
    <button data-tab="live">üî¥ Vivo</button>
    <button data-tab="table">üìä Tabla</button>
    <button data-tab="cal">üóìÔ∏è Cal</button>
    <button data-tab="teams">‚öôÔ∏è Equipos</button>
  </nav>
</div>

<script>
/* ===== App logic con mejoras visibles ===== */
const WORKER="https://test.christiansanabria.workers.dev";
const BARCA_ID="81";
const COUNTRY="Spain"; const LANG="es-ES", GL="ES", CEID="ES:es";

const state={ theme:"light", teamId: localStorage.getItem("teamId")||BARCA_ID, crestMap:{}, deferredPrompt:null };

const $=(q,el=document)=>el.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
function setTheme(t){ state.theme=t; $("#app").dataset.theme=t; localStorage.setItem("theme",t); document.body.style.transition = 'background 0.5s'; }
setTheme(localStorage.getItem("theme")||"light");
$("#themeBtn").onclick=()=> setTheme(state.theme==="light"?"dark":"light");

/* Tabs con slide animation */
function switchTab(name){
  $$(".bn button, .tabs [data-tab]").forEach(x=> x.classList.toggle("active", x.dataset.tab===name));
  ["next","past","live","table","cal","teams"].forEach(id=> {
    const el = $("#tab-"+id);
    el.classList.toggle("hidden", id!==name);
    if (id === name) el.style.animation = 'fadeInUp 0.6s ease-out';
  });
  if(name==="table") loadStandings();
  if(name==="past") loadPast();
  if(name==="live") loadLive();
  if(name==="cal") loadCalendar();
}

/* Parallax en scroll */
window.addEventListener('scroll', () => {
  document.querySelector('.app').classList.toggle('scrolled', window.scrollY > 100);
});

/* Mostrar spinner durante loads */
function showSpinner(show = true) { document.querySelector('.loading-spinner').style.display = show ? 'block' : 'none'; }

/* NEXT con animaciones */
async function loadNext(teamId){
  showSpinner(true);
  await ensureCrests();
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","SCHEDULED"); u.searchParams.set("country",COUNTRY); u.searchParams.set("include_tv","1");
  const data=await (await fetch(u)).json();
  const next=(data.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
  showSpinner(false);
  if(!next) return; // Manejo similar al original, pero con spinner

  // Resto similar, pero agrega classes para animaciones
  const hN=next.homeTeam?.name||"", aN=next.awayTeam?.name||""; const hId=next.homeTeam?.id, aId=next.awayTeam?.id;
  const homeC=crestEl(hId,hN), awayC=crestEl(aId,aN); homeC.id="homeCrest"; awayC.id="awayCrest";
  $("#homeCrest").replaceWith(homeC); $("#awayCrest").replaceWith(awayC);
  $("#homeName").textContent=hN; $("#awayName").textContent=aN;

  const {d,t}=parts(next.utcDate); $("#whenText").textContent=`${d} ¬∑ ${t}`;
  $("#compText").textContent = next.competition?.name || "";
  const sb=$("#statusBadges"); sb.innerHTML=""; sb.appendChild(badge(COUNTRY)); if(next.status) sb.appendChild(badge(next.status));

  const tv=$("#tvRow"); tv.innerHTML=""; const chans=(next.tv?.channels)||[];
  chans.forEach(name=>{ const e=document.createElement("div"); e.className="tv"; e.innerHTML=`<span class="tv-dot"></span><strong>${name}</strong>`; tv.appendChild(e); });

  await loadOdds(hN, aN);
  await loadNews(hN, aN);
}

/* TABLE con chart generado */
async function loadStandings(){
  showSpinner(true);
  const chart=$("#chart"); chart.innerHTML="";
  const data=await (await fetch(WORKER+"/standings")).json(); const rows=(data?.standings?.[0]?.table)||[];
  $("#tableUpdated").textContent=new Date().toLocaleString("es-ES");
  showSpinner(false);
  if(!rows.length) return;
  const maxPoints = Math.max(...rows.map(r => r.points));
  rows.forEach(r => {
    const bar = document.createElement("div"); bar.className = "chart-bar";
    bar.style.width = `${(r.points / maxPoints) * 100}%`;
    bar.dataset.label = `${r.team?.name} - ${r.points} pts`;
    if (String(r.team?.id) === "81") bar.style.background = "linear-gradient(to right, var(--ok), var(--brand))";
    chart.appendChild(bar);
  });
}

/* Init y resto similar, con spinners */
(async function init(){ renderTeams(); switchTab("next"); await loadNext(state.teamId); loadStandings(); })();
$$(".bn button, .tabs [data-tab]").forEach(b=> b.onclick=()=> switchTab(b.dataset.tab));

// Funciones helpers iguales, pero agrega showSpinner en fetches
// Por ejemplo, en loadNews, loadOdds, etc., agrega showSpinner(true/false);
</script>
</body>
</html>