<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tracker</title>
  <meta name="theme-color" content="#ffffff" />
  <!-- Estilos inlined: mobile-first, claro por defecto, dark-toggle, glassy 2025 vibes -->
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffffcc; --ink:#0f1220; --muted:#60646c; --brand:#3a66ff;
      --ok:#16a34a; --warn:#b45309; --danger:#dc2626; --ring:#00000010; --blur:12px;
      --shadow:0 10px 30px rgba(16,20,40,.08), 0 2px 6px rgba(16,20,40,.06);
      --radius:18px; --radius-sm:12px; --radius-xs:10px;
      --chip:#eef1ff; --chip-ink:#2c3a8c; --grad:linear-gradient(135deg,#4e6cff 0%,#9b4dff 100%);
    }
    [data-theme="dark"]{
      --bg:#0b0d12; --card:#111523cc; --ink:#e8ebff; --muted:#aeb3c2; --brand:#8aa2ff;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ring:#ffffff19; --chip:#1a1f35; --chip-ink:#b9c2ff;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font:500 16px/1.45 "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{max-width:640px; margin:0 auto; padding:12px 12px 24px; display:grid; gap:12px}
    header{
      position:sticky; top:0; z-index:50; padding:10px; backdrop-filter:saturate(1.2) blur(var(--blur));
      background:linear-gradient(to bottom, var(--bg), transparent 85%);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:38px; height:38px; border-radius:999px; background:var(--grad); position:relative; box-shadow:var(--shadow)}
    .logo:before{content:""; position:absolute; inset:6px; border-radius:999px; background:radial-gradient(circle at 30% 30%, #fff6, transparent 55%)}
    .logo:after{
      content:""; position:absolute; inset:auto 9px 9px 9px; height:14px; border-radius:8px 8px 2px 2px;
      background:#fff9; transform:skew(-8deg); box-shadow:inset 0 0 0 2px #fff8;
    }
    .title{font-weight:800; letter-spacing:.2px}
    .btn{
      appearance:none; border:0; border-radius:14px; padding:10px 14px; background:var(--ink); color:#fff; font-weight:700;
      box-shadow:var(--shadow); transform:translateZ(0); transition:transform .1s ease, opacity .2s ease, filter .2s;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{background:var(--chip); color:var(--chip-ink); box-shadow:none}
    .btn.ghost{background:transparent; color:var(--ink)}
    .btn.icon{width:44px; height:44px; padding:0; display:grid; place-items:center; border:1px solid var(--ring); background:transparent}
    .cards{display:grid; gap:12px}
    .card{
      border-radius:var(--radius); background:var(--card); backdrop-filter:blur(var(--blur));
      box-shadow:var(--shadow); padding:14px; border:1px solid var(--ring);
    }
    .kicker{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.14em}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row.nowrap{flex-wrap:nowrap}
    .teams{display:grid; grid-template-columns:1fr auto 1fr; gap:8px; align-items:center}
    .club{display:grid; justify-items:center}
    .crest{width:54px; height:54px; border-radius:16px; background:var(--chip); display:grid; place-items:center; font-weight:800; color:var(--chip-ink)}
    .vs{font-weight:900; font-size:13px; color:var(--muted)}
    .when{font-weight:800; font-size:18px}
    .sub{color:var(--muted); font-size:13px}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{font-size:12px; padding:6px 10px; background:var(--chip); color:var(--chip-ink); border-radius:999px}
    .odds{display:grid; gap:8px}
    .market{display:grid; gap:8px}
    .pill{
      display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:var(--radius-sm);
      border:1px solid var(--ring); background:#fff; color:#0f1220;
    }
    [data-theme="dark"] .pill{background:#1a2033; color:#e8ebff}
    .pill strong{font-size:15px}
    .grid{display:grid; gap:10px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .section-title{display:flex; align-items:center; justify-content:space-between}
    .section-title h3{margin:0; font-size:16px}
    .link{color:var(--brand); text-decoration:none; font-weight:700}
    .divider{height:1px; background:var(--ring); margin:6px 0}
    .tv-logos{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tv{display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--ring); border-radius:12px; background:#fff}
    [data-theme="dark"] .tv{background:#131a2b}
    .tv .logo{width:24px; height:24px; border-radius:6px; box-shadow:none; background:var(--grad)}
    .search{position:relative}
    .search input{
      width:100%; padding:12px 44px 12px 12px; border-radius:14px; border:1px solid var(--ring); background:#fff;
      outline:none; font-weight:600;
    }
    [data-theme="dark"] .search input{background:#0e1425}
    .search .ic{position:absolute; right:8px; top:8px}
    .tabs{display:flex; gap:8px; overflow:auto; padding:2px 0}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid var(--ring); background:transparent; white-space:nowrap}
    .tab.active{background:var(--ink); color:#fff}
    .standings{width:100%; border-collapse:separate; border-spacing:0 8px}
    .standings td{background:var(--card); padding:10px 8px; border:1px solid var(--ring)}
    .standings tr{border-radius:10px}
    .fav{cursor:pointer}
    .hidden{display:none !important}
    .tiny{font-size:12px; color:var(--muted)}
    .skeleton{animation:sheen 1.1s linear infinite; background:linear-gradient(90deg,#0000,#00000008,#0000); background-size:240% 100%}
    @keyframes sheen{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="app" id="app" data-theme="light">
    <header>
      <div class="nav">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="title">Tracker</div>
            <div class="tiny">Bar√ßa primero. El resto, si insistes.</div>
          </div>
        </div>
        <div class="row">
          <button class="btn icon" id="themeBtn" title="Modo claro/oscuro" aria-label="Cambiar tema">üåó</button>
          <button class="btn icon" id="installBtn" title="Instalar">‚¨áÔ∏è</button>
        </div>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab active" data-tab="next">Siguiente</button>
        <button class="tab" data-tab="past">Pasados</button>
        <button class="tab" data-tab="live">En vivo</button>
        <button class="tab" data-tab="table">Clasificaci√≥n</button>
        <button class="tab" data-tab="teams">Equipos</button>
      </div>
    </header>

    <!-- Siguiente Partido -->
    <section id="tab-next" class="cards">
      <article class="card" id="nextCard">
        <div class="kicker">Siguiente partido</div>
        <div class="teams" id="teamsRow">
          <div class="club"><div class="crest">BAR</div><div id="homeName" class="sub">FC Barcelona</div></div>
          <div class="vs">vs</div>
          <div class="club"><div class="crest">???</div><div id="awayName" class="sub">Cargando...</div></div>
        </div>
        <div class="when" id="whenText">‚Äî</div>
        <div class="sub" id="compText">‚Äî</div>
        <div class="badges" id="statusBadges"></div>
        <div class="divider"></div>
        <div class="section-title">
          <h3>TV</h3>
          <span class="tiny">Espa√±a</span>
        </div>
        <div class="tv-logos" id="tvRow"><span class="tiny">Buscando canales...</span></div>
        <div class="divider"></div>
        <div class="section-title">
          <h3>Cuotas</h3>
          <span class="tiny">1X2 y Over/Under 2.5</span>
        </div>
        <div id="oddsBox" class="odds"><div class="tiny">Se muestran si est√°n disponibles.</div></div>
        <div class="divider"></div>
        <div class="section-title">
          <h3>Noticias del partido</h3>
          <a class="link" id="refreshNews" href="#">Actualizar</a>
        </div>
        <div id="newsList" class="grid"></div>
        <div class="divider"></div>
        <div class="row nowrap">
          <button class="btn secondary" id="notifyBtn">Recordarme</button>
          <button class="btn" id="icsBtn">A√±adir al calendario</button>
        </div>
      </article>
    </section>

    <!-- Pasados -->
    <section id="tab-past" class="cards hidden">
      <article class="card">
        <div class="kicker">Partidos pasados</div>
        <div id="pastList" class="grid"></div>
      </article>
    </section>

    <!-- En vivo -->
    <section id="tab-live" class="cards hidden">
      <article class="card">
        <div class="kicker">Ahora mismo</div>
        <div id="liveList" class="grid"></div>
      </article>
    </section>

    <!-- Clasificaci√≥n -->
    <section id="tab-table" class="cards hidden">
      <article class="card">
        <div class="section-title"><h3>LaLiga</h3><span class="tiny" id="tableUpdated">‚Äî</span></div>
        <table class="standings" id="table"></table>
      </article>
    </section>

    <!-- Equipos -->
    <section id="tab-teams" class="cards hidden">
      <article class="card">
        <div class="section-title"><h3>Busca otro equipo</h3><span class="tiny">Favoritos ‚òÖ</span></div>
        <div class="search"><input id="teamSearch" placeholder="Buscar equipo (LaLiga)" autocomplete="off"/><div class="ic">üîé</div></div>
        <div id="teamChips" class="badges" style="margin-top:8px"></div>
        <div class="divider"></div>
        <div id="leagueList" class="grid"></div>
      </article>
    </section>
  </div>

  <script>
  // ---------- Config
  const WORKER = "https://test.christiansanabria.workers.dev";
  const BARCA_ID = "81"; // Bar√ßa (Football-Data) ‚Äî expuesto en tu worker
  const COUNTRY = "Spain"; // TV Spain
  const LANG = "es-ES", GL = "ES", CEID = "ES:es";
  const REFRESH_LIVE_MS = 60000; // 60s en vivo

  // Mapa simple de equipos LaLiga (de tu worker) para selector/favoritos
  const TEAM_MAP = {
    "FC Barcelona":"81","Real Madrid CF":"86","Atl√©tico de Madrid":"78","Athletic Bilbao":"77","Real Sociedad":"92",
    "Villarreal CF":"94","Real Betis":"90","Valencia CF":"95","Sevilla FC":"559","RC Celta de Vigo":"558",
    "RCD Espanyol de Barcelona":"80","Getafe CF":"82","CA Osasuna":"79","Deportivo Alav√©s":"263","Girona FC":"298",
    "UD Las Palmas":"275","Rayo Vallecano":"87","RCD Mallorca":"1041","CD Legan√©s":"745","Real Valladolid CF":"250"
  };

  // ---------- Estado
  const state = {
    theme: localStorage.getItem("theme") || "light",
    teamId: localStorage.getItem("teamId") || BARCA_ID,
    teamName: "FC Barcelona",
    nextMatch: null,
    nextOdds: null,
    liveTimer: null,
    deferredPrompt: null,
    favs: JSON.parse(localStorage.getItem("favs") || "[]")
  };

  // ---------- Utiles
  const $ = (q, el=document)=>el.querySelector(q);
  const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
  const fmtDate = (iso)=> new Date(iso);
  function timeParts(iso){
    const d = new Date(iso);
    const dt = d.toLocaleDateString("es-ES", { weekday:"short", day:"2-digit", month:"short" });
    const tt = d.toLocaleTimeString("es-ES", { hour:"2-digit", minute:"2-digit" });
    return {dt,tt};
  }
  function crestText(name){
    const n=(name||"").toUpperCase().replace(/[^A-Z√Å√â√ç√ì√ö√ú√ë]/g," ").trim().split(/\s+/);
    return (n[0]?.slice(0,3) || "???");
  }
  function tag(el, cls, html){ const x=document.createElement(el); if(cls) x.className=cls; if(html!=null) x.innerHTML=html; return x; }
  function setTheme(t){ state.theme=t; document.getElementById("app").dataset.theme=t; localStorage.setItem("theme",t); }

  // ---------- Tabs
  $$(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      $$(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const name = b.dataset.tab;
      ["next","past","live","table","teams"].forEach(id=>{
        $("#tab-"+id).classList.toggle("hidden", id!==name);
      });
      if(name==="table") loadStandings();
      if(name==="past") loadPast();
      if(name==="live") loadLive();
      if(name==="next") ensureLiveTimer();
    });
  });

  // ---------- Theme + Install
  document.getElementById("themeBtn").onclick=()=> setTheme(state.theme==="light" ? "dark" : "light");
  window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); state.deferredPrompt=e; $("#installBtn").classList.remove("hidden"); });
  document.getElementById("installBtn").onclick=async()=>{
    if(state.deferredPrompt){ state.deferredPrompt.prompt(); state.deferredPrompt=null; }
  };

  // ---------- Service Worker + Manifest (generados al vuelo)
  (function setupPWA(){
    const manifest = {
      name:"Tracker", short_name:"Tracker", theme_color:"#ffffff", background_color:"#ffffff",
      display:"standalone", scope:"./", start_url:"./", lang:"es-ES",
      icons:[
        { src:"icon-192.png", sizes:"192x192", type:"image/png" },
        { src:"icon-512.png", sizes:"512x512", type:"image/png" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("link"); link.rel="manifest"; link.href=url; document.head.appendChild(link);

    // Service worker simple: cache shell + runtime GET
    const sw = `
      const CACHE = "tracker-v1";
      self.addEventListener("install", e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(["./"])));
        self.skipWaiting();
      });
      self.addEventListener("activate", e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener("fetch", e=>{
        const req = e.request;
        if(req.method!=="GET"){ return; }
        e.respondWith((async()=>{
          try{
            const net = await fetch(req);
            const c = await caches.open(CACHE); c.put(req, net.clone());
            return net;
          }catch(err){
            const hit = await caches.match(req); if(hit) return hit;
            return new Response("Offline", {status:503});
          }
        })());
      });
    `;
    const swUrl = URL.createObjectURL(new Blob([sw],{type:"text/javascript"}));
    if("serviceWorker" in navigator){ navigator.serviceWorker.register(swUrl).catch(()=>{}); }
  })();

  // ---------- Notificaciones locales
  document.getElementById("notifyBtn").onclick=async()=>{
    if(!state.nextMatch){ return; }
    const perm = await Notification.requestPermission();
    if(perm!=="granted"){ alert("Permiso de notificaciones denegado."); return; }
    const t0 = new Date(state.nextMatch.utcDate).getTime();
    const now = Date.now();
    const fire = (ms, body)=> setTimeout(()=> new Notification("Tracker", { body }), ms);
    if(t0 - now > 10*60*1000) fire(t0-now-10*60*1000, "El partido empieza en 10 minutos.");
    if(t0 - now > 0) fire(t0-now, "¬°Rueda el bal√≥n!");
    alert("Recordatorios programados en este dispositivo.");
  };

  // ---------- ICS: a√±adir al calendario
  document.getElementById("icsBtn").onclick=()=>{
    if(!state.nextMatch) return;
    const m = state.nextMatch;
    const dtStart = new Date(m.utcDate);
    const dtEnd = new Date(dtStart.getTime() + 2*60*60*1000);
    function icsDate(d){ return d.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"); }
    const ics = [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Tracker//ES",
      "BEGIN:VEVENT",
      `DTSTAMP:${icsDate(new Date())}`,
      `DTSTART:${icsDate(dtStart)}`,
      `DTEND:${icsDate(dtEnd)}`,
      `SUMMARY:${m.homeTeam} vs ${m.awayTeam}`,
      `DESCRIPTION:${m.competition || "F√∫tbol"} ‚Äî Generado por Tracker`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
    const blob = new Blob([ics],{type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="partido.ics"; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
  };

  // ---------- TV logos: render initials ‚Äúlogo‚Äù
  function tvLogo(name){
    const el = tag("div","tv");
    const lg = tag("div","logo"); el.appendChild(lg);
    el.appendChild(tag("span","", name));
    return el;
  }

  // ---------- Cargas
  async function loadNext(teamId=state.teamId){
    try{
      // 1) Siguiente partido con TV desde /matches
      const u = new URL(WORKER+"/matches");
      u.searchParams.set("team", teamId);
      u.searchParams.set("status", "SCHEDULED");
      u.searchParams.set("country", COUNTRY);
      u.searchParams.set("include_tv", "1");
      const r = await fetch(u); const matches = await r.json();
      const next = (matches.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
      if(!next){ $("#whenText").textContent = "Sin pr√≥ximo partido"; return; }

      const home = next.homeTeam?.name || ""; const away = next.awayTeam?.name || "";
      state.nextMatch = {
        utcDate: next.utcDate, status: next.status, homeTeam: home, awayTeam: away,
        competition: next.competition?.name || "", tv: next.tv || null
      };
      $("#homeName").textContent = home;
      $("#awayName").textContent = away;
      $(".crest").textContent = crestText(home);
      $$(".club .crest")[1].textContent = crestText(away);

      const {dt,tt} = timeParts(next.utcDate);
      $("#whenText").textContent = `${dt} ¬∑ ${tt}`;
      $("#compText").textContent = state.nextMatch.competition || "";

      // Badges de estado
      const sb = $("#statusBadges"); sb.innerHTML="";
      sb.appendChild(tag("div","badge", COUNTRY));
      if(next.status) sb.appendChild(tag("div","badge", next.status));

      // TV
      const tv = $("#tvRow"); tv.innerHTML = "";
      const chans = (next.tv?.channels || []);
      if(chans.length){ chans.forEach(c=> tv.appendChild(tvLogo(c))); }
      else { tv.innerHTML = '<span class="tiny">Sin canal definido todav√≠a</span>'; }

      // 2) Cuotas solo para el siguiente partido
      await loadOdds(home, away);

      // 3) Noticias solo del siguiente partido
      await loadNews(home, away);

      ensureLiveTimer();
    }catch(e){
      console.error(e);
    }
  }

  async function loadOdds(home, away){
    const box = $("#oddsBox"); box.innerHTML = `<div class="tiny">Cargando cuotas‚Ä¶</div>`;
    try{
      // Intento 1: /odds_next
      const u1 = new URL(WORKER + "/odds_next");
      u1.searchParams.set("team", state.teamId);
      u1.searchParams.set("markets","1x2,ou2.5");
      let data = await (await fetch(u1)).json();
      // Si la estructura no trae markets normalizados, pruebo /odds directo
      if(Array.isArray(data) && !data.match){ data = { data }; }
      if(!data || (Array.isArray(data) && !data.length) || data.error){
        const u2 = new URL(WORKER + "/odds");
        u2.searchParams.set("home", home); u2.searchParams.set("away", away);
        u2.searchParams.set("markets","1x2,ou2.5");
        data = await (await fetch(u2)).json();
      }
      renderOdds(data, box);
    }catch(e){
      box.innerHTML = `<div class="tiny">No hay cuotas disponibles por ahora.</div>`;
    }
  }

  function renderOdds(data, box){
    // La normalizaci√≥n del worker expone mejores precios por mercado; si no, muestro mensaje
    try{
      const arr = Array.isArray(data) ? data : (data.normalized || data.data || []);
      if(!arr || !arr.length){ box.innerHTML = `<div class="tiny">No hay cuotas disponibles todav√≠a.</div>`; return; }
      // Buscar objetos tipo h2h y totals
      const mkH2H = arr.find(x=> (x.market||"").toLowerCase().includes("1x2") || (x.type||"") === "h2h" || x.key==="h2h");
      const mkTotals = arr.find(x=> (x.market||"").toLowerCase().includes("ou2.5") || x.key==="totals" || (x.type||"").includes("totals"));
      box.innerHTML = "";

      if(mkH2H){
        const g = tag("div","market");
        g.appendChild(tag("div","kicker","1X2 mejor precio"));
        const grid = tag("div","grid cols-3");
        const legs = [
          {label:"1", val: bestOf(mkH2H, ["home","1"])},
          {label:"X", val: bestOf(mkH2H, ["draw","x"])},
          {label:"2", val: bestOf(mkH2H, ["away","2"])}
        ];
        legs.forEach(({label,val})=>{
          const pill = tag("div","pill");
          pill.innerHTML = `<strong>${label}</strong><span>${val?.price ?? "‚Äî"} <small class="tiny">${val?.book ? "¬∑ "+val.book : ""}</small></span>`;
          grid.appendChild(pill);
        });
        g.appendChild(grid);
        box.appendChild(g);
      }
      if(mkTotals){
        const g = tag("div","market");
        g.appendChild(tag("div","kicker","Over/Under 2.5"));
        const grid = tag("div","grid cols-2");
        const over = bestOverUnder(mkTotals, "over");
        const under = bestOverUnder(mkTotals, "under");
        const p1 = tag("div","pill"); p1.innerHTML = `<strong>Over 2.5</strong><span>${over?.price ?? "‚Äî"} <small class="tiny">${over?.book ? "¬∑ "+over.book : ""}</small></span>`;
        const p2 = tag("div","pill"); p2.innerHTML = `<strong>Under 2.5</strong><span>${under?.price ?? "‚Äî"} <small class="tiny">${under?.book ? "¬∑ "+under.book : ""}</small></span>`;
        grid.appendChild(p1); grid.appendChild(p2);
        g.appendChild(grid);
        box.appendChild(g);
      }
      if(!mkH2H && !mkTotals){
        box.innerHTML = `<div class="tiny">No hay mercados 1X2/OU2.5 ahora mismo.</div>`;
      }
    }catch(e){
      box.innerHTML = `<div class="tiny">No hay cuotas disponibles todav√≠a.</div>`;
    }
  }

  // Intenta encontrar mejor cuota seg√∫n convenciones comunes del normalizador
  function bestOf(mk, keys){
    const obj = mk.best || mk.h2h || mk.data || mk; // agn√≥stico
    for(const k of keys){
      const leg = obj[k] || (obj.outcomes?.find(o=> (o.name||"").toLowerCase().includes(k)) );
      if(leg && typeof leg.price!=="undefined") return leg;
    }
    return null;
  }
  function bestOverUnder(mk, side){
    const obj = mk.best || mk.totals || mk.data || mk;
    const outcomes = obj.outcomes || [];
    // fallback: elegir por name contiene "over" / "under" y point ~2.5
    const pref = outcomes
      .map(o=>({...o, point: Number(o.point ?? (/(\d+(\.\d+)?)$/.exec(o.name||"")||[])[1])}))
      .filter(o=> (o.name||"").toLowerCase().includes(side))
      .sort((a,b)=> Math.abs((a.point??2.5)-2.5) - Math.abs((b.point??2.5)-2.5))[0];
    if(pref) return pref;
    return obj[side];
  }

  async function loadNews(home, away){
    const list = $("#newsList"); list.innerHTML = `<div class="tiny">Buscando previas y noticias‚Ä¶</div>`;
    try{
      const u = new URL(WORKER + "/news");
      u.searchParams.set("home", home); u.searchParams.set("away", away);
      u.searchParams.set("lang", LANG); u.searchParams.set("gl", GL); u.searchParams.set("ceid", CEID);
      const data = await (await fetch(u)).json();
      const items = Array.isArray(data) ? data : (data.items || data.data || []);
      list.innerHTML = "";
      if(!items || !items.length){ list.innerHTML = `<div class="tiny">Sin noticias por ahora.</div>`; return; }
      for(const it of items.slice(0,6)){
        const card = tag("div","pill");
        const t = (it.title || "").replace(/&amp;/g,"&");
        const src = it.source ? ` ¬∑ <span class="tiny">${it.source}</span>` : "";
        card.innerHTML = `<strong>${t}</strong><span class="tiny">${new Date(it.pubDate).toLocaleString("es-ES")}${src}</span>`;
        card.onclick = ()=> window.open(it.link, "_blank", "noopener");
        list.appendChild(card);
      }
      $("#refreshNews").onclick=(e)=>{ e.preventDefault(); loadNews(home, away); };
    }catch(e){
      list.innerHTML = `<div class="tiny">No se pudo cargar noticias.</div>`;
    }
  }

  async function loadPast(teamId=state.teamId){
    const box = $("#pastList"); box.innerHTML = "";
    const u = new URL(WORKER+"/matches");
    u.searchParams.set("team", teamId); u.searchParams.set("status","FINISHED"); u.searchParams.set("include_tv","0");
    const data = await (await fetch(u)).json();
    const arr = (data.matches||[]).slice(-10).reverse();
    if(!arr.length){ box.innerHTML = `<div class="tiny">No hay registros recientes.</div>`; return; }
    for(const m of arr){
      const row = tag("div","pill");
      const {dt,tt} = timeParts(m.utcDate);
      row.innerHTML = `<strong>${m.homeTeam?.name} vs ${m.awayTeam?.name}</strong><span>${dt} ¬∑ ${tt}</span>`;
      box.appendChild(row);
    }
  }

  async function loadLive(teamId=state.teamId){
    const box = $("#liveList"); box.innerHTML = "";
    const u = new URL(WORKER+"/matches");
    u.searchParams.set("team", teamId); u.searchParams.set("status","LIVE"); u.searchParams.set("include_tv","1");
    const data = await (await fetch(u)).json();
    const arr = data.matches||[];
    if(!arr.length){ box.innerHTML = `<div class="tiny">Nada en vivo ahora mismo.</div>`; return; }
    for(const m of arr){
      const row = tag("div","pill");
      row.innerHTML = `<strong>${m.homeTeam?.name} vs ${m.awayTeam?.name}</strong><span>${(m.status||"LIVE")}</span>`;
      box.appendChild(row);
    }
  }

  async function loadStandings(){
    const tbl = $("#table"); tbl.innerHTML = "";
    const url = WORKER + "/standings";
    const data = await (await fetch(url)).json();
    const table = data?.standings?.[0]?.table || [];
    $("#tableUpdated").textContent = new Date().toLocaleString("es-ES");
    if(!table.length){ tbl.innerHTML = `<tr><td>No disponible</td></tr>`; return; }
    for(const row of table){
      const tr = tag("tr","");
      const pos = tag("td","", `<strong>${row.position}</strong>`);
      const name = tag("td","", row.team?.name || "");
      const pts = tag("td","", `<strong>${row.points}</strong>`);
      const pj = tag("td","", `PJ ${row.playedGames}`);
      const gf = tag("td","", `GF ${row.goalsFor}`); const gc = tag("td","", `GC ${row.goalsAgainst}`);
      tr.appendChild(pos); tr.appendChild(name); tr.appendChild(pts); tr.appendChild(pj); tr.appendChild(gf); tr.appendChild(gc);
      // pinta Bar√ßa
      if((row.team?.name||"").toLowerCase().includes("barcelona")) tr.style.outline = "2px solid var(--brand)";
      tbl.appendChild(tr);
    }
  }

  // ---------- Equipos: buscador + chips por liga
  function renderTeams(){
    const chips = $("#teamChips"); chips.innerHTML = "";
    // Favoritos
    if(state.favs.length){
      const favWrap = tag("div","badges");
      state.favs.forEach(id=>{
        const name = Object.keys(TEAM_MAP).find(k=>TEAM_MAP[k]===id);
        if(!name) return;
        const b = tag("div","badge fav","‚òÖ "+name);
        b.onclick=()=> switchTeam(id, name);
        chips.appendChild(b);
      });
    }
    // Liga chips
    const list = $("#leagueList"); list.innerHTML = "";
    Object.entries(TEAM_MAP).forEach(([name,id])=>{
      const b = tag("div","badge fav",name);
      b.onclick=()=> switchTeam(id,name);
      list.appendChild(b);
    });

    // Buscador
    $("#teamSearch").oninput=(e)=>{
      const q = e.target.value.toLowerCase();
      $$("#leagueList .badge").forEach(b=>{
        b.classList.toggle("hidden", !b.textContent.toLowerCase().includes(q));
      });
    };
  }
  function switchTeam(id, name){
    state.teamId = id; state.teamName = name;
    localStorage.setItem("teamId", id);
    // add to favs at most 6
    if(!state.favs.includes(id)){ state.favs = [id, ...state.favs].slice(0,6); localStorage.setItem("favs", JSON.stringify(state.favs)); }
    // reset UI
    $(".tab[data-tab='next']").click();
    loadNext(id);
  }

  // ---------- Live refresher
  function ensureLiveTimer(){
    if(state.liveTimer){ clearInterval(state.liveTimer); state.liveTimer=null; }
    if(!state.nextMatch) return;
    const status = (state.nextMatch.status||"").toUpperCase();
    if(status==="LIVE"){ state.liveTimer = setInterval(()=> loadNext(state.teamId), REFRESH_LIVE_MS); }
  }
  document.addEventListener("visibilitychange",()=>{
    if(document.hidden){ if(state.liveTimer){ clearInterval(state.liveTimer); state.liveTimer=null; } }
    else { ensureLiveTimer(); }
  });

  // ---------- Iniciar
  (async function init(){
    setTheme(state.theme);
    renderTeams();
    await loadNext(state.teamId);
    // precarga liviana
    loadStandings();
  })();
  </script>
</body>
</html>
