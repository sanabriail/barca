<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tracker Modernizado</title>
<meta name="theme-color" content="#0a0d14">
<style>
  @font-face { font-family: 'Inter'; src: url('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2') format('woff2'); font-weight: 1 1000; font-style: normal; font-display: swap; }
  :root {
    --bg: linear-gradient(135deg, #f6f8ff, #e9edff); --card: #ffffff; --ink: #0d1230; --muted: #5c637a; --ring: #e5e9ff;
    --brand: #3b6cff; --brand2: #8b5cf6; --ok: #16a34a; --bad: #ef4444;
    --radius: clamp(16px, 4vw, 24px); --sm: clamp(12px, 3vw, 14px);
    --shadow-neu: 8px 8px 16px rgba(0,0,0,0.1), -8px -8px 16px rgba(255,255,255,0.5);
    --glass: blur(30px) saturate(1.8);
  }
  [data-theme="dark"] {
    --bg: linear-gradient(135deg, #0a0d14, #101523); --card: #0f1629; --ink: #e9edff; --muted: #96a0bb; --ring: #223056;
    --brand: #7da2ff; --brand2: #b892ff; --shadow-neu: 8px 8px 16px rgba(0,0,0,0.3), -8px -8px 16px rgba(255,255,255,0.05);
  }
  * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  html, body { height: 100%; }
  body {
    margin: 0; color: var(--ink); font: 500 clamp(16px, 4vw, 18px)/1.6 'Inter', system-ui;
    background: var(--bg); background-size: 200% 200%; animation: gradientFlow 15s ease infinite;
    overflow-x: hidden; position: relative;
  }
  @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  /* Partículas sutiles en background */
  body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(59,108,255,0.1) 0%, transparent 70%); opacity: 0.5; animation: particles 20s infinite; pointer-events: none; }
  @keyframes particles { 0% { transform: translate(0, 0); } 100% { transform: translate(20px, 20px); } }
  .app { max-width: 560px; margin: 0 auto; min-height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; position: relative; }

  /* Header más prominente con parallax */
  header { position: sticky; top: 0; z-index: 40; padding: var(--sm) 16px; backdrop-filter: var(--glass); background: color-mix(in oklab, var(--bg) 80%, transparent); transform: translateY(0); box-shadow: var(--shadow-neu); border-radius: 0 0 var(--radius) var(--radius); }
  .app.scrolled header { transform: translateY(-10px) scale(0.98); }
  .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .brand { display: flex; gap: 12px; align-items: center; }
  .logo { width: 50px; height: 50px; border-radius: var(--radius); box-shadow: var(--shadow-neu); background: linear-gradient(135deg, var(--brand), var(--brand2)); animation: logoGlow 2s infinite alternate; }
  @keyframes logoGlow { 0% { box-shadow: 0 0 10px var(--brand); } 100% { box-shadow: 0 0 20px var(--brand2); } }
  .logo:hover { transform: rotate(360deg); transition: transform 0.6s; }
  .logo svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
  .title { font-weight: 900; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }

  /* Tabs como segmented control con swipe effect */
  .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 8px; background: color-mix(in oklab, var(--card) 50%, transparent); border-radius: var(--radius); scroll-snap-type: x mandatory; }
  .pill { padding: 10px 16px; border-radius: var(--radius); background: var(--card); box-shadow: var(--shadow-neu); color: var(--ink); position: relative; scroll-snap-align: center; }
  .pill.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; box-shadow: 0 0 15px var(--brand); }
  .pill:hover { transform: scale(1.1); }

  /* Screen con slide-in animation */
  .screen { padding: 16px 16px 120px; display: grid; gap: 16px; animation: slideIn 0.6s ease-out; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: none; } }
  .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow-neu); padding: 16px; position: relative; overflow: hidden; }
  .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(var(--brand-rgb),0.1) 0%, transparent 70%); opacity: 0; transition: opacity 0.3s; }
  .card:hover::before { opacity: 1; }
  .card:hover { transform: translateY(-8px) rotate(1deg); }

  /* Match hero asimétrico */
  .teams { display: flex; justify-content: space-around; align-items: center; gap: 20px; margin-top: 12px; }
  .club { text-align: center; transform: skew(-5deg); transition: transform 0.3s; }
  .club:hover { transform: skew(0) scale(1.1); }
  .crest { width: 80px; height: 80px; border-radius: var(--radius); box-shadow: var(--shadow-neu); background: var(--card); }
  .vs { font-size: 24px; font-weight: 900; color: var(--brand); text-shadow: 2px 2px 4px rgba(0,0,0,0.2); animation: vsPulse 1.5s infinite; }
  @keyframes vsPulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

  /* TV con ripple */
  .tv { padding: 10px 14px; border-radius: var(--radius); box-shadow: var(--shadow-neu); position: relative; overflow: hidden; }
  .tv:hover { background: color-mix(in oklab, var(--brand) 20%, var(--card)); }
  .tv-dot { width: 8px; height: 8px; border-radius: 999px; background: var(--brand); animation: pulse 1s infinite; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

  /* Odds */
  .grid { display: grid; gap: 10px; }
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .od { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid var(--ring); border-radius: 14px; }

  /* News como carrusel con scroll snap */
  .news { display: flex; overflow-x: auto; gap: 12px; scroll-snap-type: x mandatory; padding-bottom: 10px; }
  .news .item { flex: 0 0 80%; scroll-snap-align: start; border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow-neu); min-width: 250px; }

  /* Standings con bar chart SVG */
  table { display: none; } /* Reemplazado por chart */
  .chart { display: flex; flex-direction: column; gap: 8px; }
  .chart-bar { height: 20px; background: linear-gradient(to right, var(--brand), var(--brand2)); border-radius: var(--radius); position: relative; }
  .chart-bar::after { content: attr(data-label); position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #fff; font-weight: bold; }

  /* Past/live rows + accordion */
  .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 12px; border: 1px solid var(--ring); border-radius: 14px; }
  .acc { display: grid; gap: 8px; }
  .acc .details { display: none; }
  .acc.open .details { display: block; }

  /* Calendar list */
  .month { font-weight: 800; margin: 6px 0 4px; }
  .cal-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px; border: 1px solid var(--ring); border-radius: 12px; }

  /* Bottom nav como dock flotante */
  .bn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 60; display: flex; gap: 8px; background: var(--card); box-shadow: var(--shadow-neu); border-radius: var(--radius); padding: 10px; animation: dockFloat 2s infinite ease-in-out; }
  @keyframes dockFloat { 0% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } 100% { transform: translate(-50%, 0); } }
  .bn button { border-radius: var(--radius); padding: 12px; background: var(--card); box-shadow: var(--shadow-neu); }
  .bn button.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; }

  /* Loader spinner global */
  .loading-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid var(--ring); border-top: 4px solid var(--brand); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; z-index: 100; display: none; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading .loading-spinner { display: block; }

  /* Media queries para móviles */
  @media (max-width: 400px) {
    .teams { flex-direction: column; }
    .bn { width: 90%; flex-wrap: wrap; justify-content: center; }
    .news { flex-direction: column; overflow-y: auto; height: 300px; }
  }

  .hidden { display: none !important; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) rotate(-5deg); } to { opacity: 1; transform: none; } }
  .kicker { font-size: 12px; letter-spacing: .12em; text-transform: uppercase; color: var(--muted); }
  .divider { height: 1px; background: var(--ring); margin: 10px 0; }
  .badges { display: flex; gap: 8px; flex-wrap: wrap; }
  .badge { font-size: 12px; background: color-mix(in oklab, var(--brand) 8%, var(--card)); border: 1px dashed var(--ring); color: var(--ink); padding: 6px 10px; border-radius: 999px; }
  .when { font-size: 18px; font-weight: 800; }
  .tiny { font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
<div class="loading-spinner"></div>
<div class="app" id="app" data-theme="light">
  <!-- HEADER -->
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="var(--brand)"/><stop offset="1" stop-color="var(--brand2)"/></linearGradient></defs><path d="M8 10h48v16c0 18-24 28-24 28S8 44 8 26z" fill="url(#g)"/><circle cx="32" cy="28" r="7" fill="#fff" opacity=".15"/></svg>
        </div>
        <div><div class="title">Tracker 2.0</div><div class="tiny">Barça primero, ahora más moderno.</div></div>
      </div>
      <div class="brand" style="gap:8px">
        <button id="themeBtn" class="pill" title="Tema">🌗</button>
        <button id="installBtn" class="pill hidden" title="Instalar">⬇️</button>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Secciones">
      <button class="pill active" data-tab="next">Siguiente</button>
      <button class="pill" data-tab="past">Pasados</button>
      <button class="pill" data-tab="live">En vivo</button>
      <button class="pill" data-tab="table">Clasificación</button>
      <button class="pill" data-tab="cal">Calendario</button>
      <button class="pill" data-tab="teams">Equipos</button>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="screen">
    <!-- NEXT con hero asimétrico -->
    <section id="tab-next" class="card">
      <div class="kicker">Siguiente Partido Épico</div>
      <div class="teams">
        <div class="club">
          <div class="crest" id="homeCrest"><div class="fallback">BAR</div></div>
          <div id="homeName" class="tiny">FC Barcelona</div>
        </div>
        <div class="vs">VS</div>
        <div class="club">
          <div class="crest" id="awayCrest"><div class="fallback">???</div></div>
          <div id="awayName" class="tiny">Cargando…</div>
        </div>
      </div>
      <div class="when" id="whenText">—</div>
      <div class="tiny" id="compText">—</div>
      <div class="badges" id="statusBadges"></div>

      <div class="divider"></div>
      <strong>TV en Vivo</strong>
      <div class="tv-logos" id="tvRow"><span class="tiny">Buscando canales…</span></div>

      <div class="divider"></div>
      <strong>Cuotas Actualizadas</strong>
      <div id="oddsBox" class="grid cols-3"></div>

      <div class="divider"></div>
      <strong>Noticias Calientes</strong>
      <div id="newsList" class="news"></div>

      <div class="divider"></div>
      <div class="row" style="gap:10px">
        <button class="pill" id="notifyBtn">Notifícame</button>
        <button class="pill active" id="icsBtn">Al Calendario</button>
      </div>
    </section>

    <!-- PAST -->
    <section id="tab-past" class="card hidden">
      <div class="kicker">Historia de Batallas</div>
      <div id="pastList" class="grid"></div>
    </section>

    <!-- LIVE -->
    <section id="tab-live" class="card hidden">
      <div class="kicker">Acción en Directo</div>
      <div id="liveList" class="grid"></div>
    </section>

    <!-- TABLE con chart -->
    <section id="tab-table" class="card hidden">
      <strong>Clasificación Visual</strong>
      <div class="chart" id="chart"></div>
      <span class="tiny" id="tableUpdated">—</span>
    </section>

    <!-- CALENDAR -->
    <section id="tab-cal" class="card hidden">
      <strong>Calendario Futuro</strong>
      <div id="calWrap" class="grid"></div>
    </section>

    <!-- TEAMS -->
    <section id="tab-teams" class="card hidden">
      <strong>Elige tu Equipo</strong>
      <input id="teamSearch" placeholder="Busca en LaLiga" style="width:100%; padding:14px; border-radius:var(--radius); box-shadow:var(--shadow-neu); background:var(--card); color:var(--ink);">
      <div id="teamChips" class="badges"></div>
      <div class="divider"></div>
      <div id="leagueList" class="badges"></div>
    </section>
  </main>

  <!-- BOTTOM NAV -->
  <nav class="bn" aria-label="Navegación">
    <button data-tab="next" class="active">▶️ Siguiente</button>
    <button data-tab="past">⏮️ Pasados</button>
    <button data-tab="live">🔴 Vivo</button>
    <button data-tab="table">📊 Tabla</button>
    <button data-tab="cal">🗓️ Cal</button>
    <button data-tab="teams">⚙️ Equipos</button>
  </nav>
</div>

<script>
/* ===== App logic con mejoras visibles y correcciones para carga ===== */
const WORKER="https://test.christiansanabria.workers.dev";
const BARCA_ID="81";
const COUNTRY="Spain"; const LANG="es-ES", GL="ES", CEID="ES:es";
const REFRESH_LIVE_MS=60000;

const state={ theme:"light", teamId: localStorage.getItem("teamId")||BARCA_ID, crestMap:{}, deferredPrompt:null };

const $=(q,el=document)=>el.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
function setTheme(t){ state.theme=t; $("#app").dataset.theme=t; localStorage.setItem("theme",t); document.body.style.transition = 'background 0.5s'; }
setTheme(localStorage.getItem("theme")||"light");
$("#themeBtn").onclick=()=> setTheme(state.theme==="light"?"dark":"light");

/* Tabs con slide animation */
function switchTab(name){
  $$(".bn button, .tabs [data-tab]").forEach(x=> x.classList.toggle("active", x.dataset.tab===name));
  ["next","past","live","table","cal","teams"].forEach(id=> {
    const el = $("#tab-"+id);
    el.classList.toggle("hidden", id!==name);
    if (id === name) el.style.animation = 'fadeInUp 0.6s ease-out';
  });
  if(name==="table") loadStandings();
  if(name==="past") loadPast();
  if(name==="live") loadLive();
  if(name==="cal") loadCalendar();
  if(name==="next") loadNext(state.teamId);
}

/* Parallax en scroll */
window.addEventListener('scroll', () => {
  document.querySelector('.app').classList.toggle('scrolled', window.scrollY > 100);
});

/* Mostrar spinner durante loads */
function showSpinner(show = true) { document.querySelector('.loading-spinner').style.display = show ? 'block' : 'none'; }

/* Helpers */
function parts(iso){ const d=new Date(iso); return {d:d.toLocaleDateString("es-ES",{weekday:"short",day:"2-digit",month:"short"}), t:d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}; }
function badge(t){ const el=document.createElement("div"); el.className="badge"; el.textContent=t; return el; }
function crestEl(id,name){ const url=state.crestMap[id]; const el=document.createElement("div"); el.className="crest"; if(url){ const img=new Image(); img.decoding="async"; img.src=url; el.appendChild(img); } else { const f=document.createElement("div"); f.className="fallback"; f.textContent=(name||"").toUpperCase().slice(0,3)||"???"; el.appendChild(f); } return el; }
async function ensureCrests(){ 
  if(Object.keys(state.crestMap).length) return; 
  try{ 
    const data=await (await fetch(WORKER+"/standings")).json(); 
    const rows=(data?.standings?.[0]?.table)||[]; 
    rows.forEach(r=>{ const id=r.team?.id; if(id) state.crestMap[id]=r.team?.crest||null; }); 
  }catch(e){ console.error("Error cargando crestas:", e); } 
}

/* NEXT con correcciones para manejo de errores y carga completa */
async function loadNext(teamId){
  showSpinner(true);
  await ensureCrests();
  try {
    const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","SCHEDULED"); u.searchParams.set("country",COUNTRY); u.searchParams.set("include_tv","1");
    const response = await fetch(u);
    if (!response.ok) throw new Error("Error en la respuesta: " + response.status);
    const data=await response.json();
    const next=(data.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
    if(!next){ 
      $("#whenText").textContent="Sin próximo partido"; 
      $("#compText").textContent=""; 
      $("#tvRow").innerHTML="<span class='tiny'>Sin datos</span>"; 
      $("#oddsBox").innerHTML=""; 
      $("#newsList").innerHTML=""; 
      showSpinner(false);
      return; 
    }

    const hN=next.homeTeam?.name||"", aN=next.awayTeam?.name||""; const hId=next.homeTeam?.id, aId=next.awayTeam?.id;
    const homeC=crestEl(hId,hN), awayC=crestEl(aId,aN); homeC.id="homeCrest"; awayC.id="awayCrest";
    $("#homeCrest").replaceWith(homeC); $("#awayCrest").replaceWith(awayC);
    $("#homeName").textContent=hN; $("#awayName").textContent=aN;

    const {d,t}=parts(next.utcDate); $("#whenText").textContent=`${d} · ${t}`;
    $("#compText").textContent = next.competition?.name || "";
    const sb=$("#statusBadges"); sb.innerHTML=""; sb.appendChild(badge(COUNTRY)); if(next.status) sb.appendChild(badge(next.status));

    const tv=$("#tvRow"); tv.innerHTML=""; const chans=(next.tv?.channels)||[];
    tv.innerHTML = chans.length ? "" : `<span class="tiny">Sin canal definido todavía</span>`;
    chans.forEach(name=>{ const e=document.createElement("div"); e.className="tv"; e.innerHTML=`<span class="tv-dot"></span><strong>${name}</strong>`; tv.appendChild(e); });

    await loadOdds(hN, aN);
    await loadNews(hN, aN);
  } catch(e) {
    console.error("Error cargando próximo partido:", e);
    $("#whenText").textContent="Error al cargar"; 
    $("#compText").textContent="Intenta de nuevo"; 
    $("#tvRow").innerHTML="<span class='tiny'>Error en la carga</span>"; 
  } finally {
    showSpinner(false);
  }
}

/* ODDS con manejo de errores */
async function loadOdds(home,away){
  const box=$("#oddsBox"); box.innerHTML=`<div class="tiny">Cargando cuotas…</div>`;
  try{
    const u1=new URL(WORKER+"/odds_next"); u1.searchParams.set("team",state.teamId); u1.searchParams.set("markets","1x2,ou2.5");
    let response = await fetch(u1);
    let data = await response.json();
    if(!data || data.error){ 
      const u2=new URL(WORKER+"/odds"); u2.searchParams.set("home",home); u2.searchParams.set("away",away); u2.searchParams.set("markets","1x2,ou2.5"); 
      response = await fetch(u2);
      data = await response.json();
    }
    renderOdds(data, box);
  }catch(e){ 
    console.error("Error cargando cuotas:", e);
    box.innerHTML=`<div class="tiny">No hay cuotas disponibles por ahora.</div>`; 
  }
}
function renderOdds(data,box){
  const arr=Array.isArray(data)?data:(data.normalized||data.data||[]);
  if(!arr||!arr.length){ box.innerHTML=`<div class="tiny">No hay cuotas disponibles.</div>`; return; }
  box.innerHTML="";
  const mkH2H=arr.find(x=>(x.key||x.market||"").toLowerCase().includes("h2h")||(x.market||"").includes("1x2"));
  const mkTotals=arr.find(x=>(x.key||"")==="totals"||(x.market||"").toLowerCase().includes("ou2.5"));
  if(mkH2H){
    const g=document.createElement("div"); g.className="grid cols-3";
    [["1","home"],["X","draw"],["2","away"]].forEach(([lbl,k])=>{
      const v=pickLeg(mkH2H,k);
      const d=document.createElement("div"); d.className="od"; d.innerHTML=`<strong>${lbl}</strong><span>${v?.price??"—"} <span class="tiny">${v?.book? "· "+v.book:""}</span></span>`;
      g.appendChild(d);
    }); box.appendChild(g);
  }
  if(mkTotals){
    const g=document.createElement("div"); g.className="grid cols-2";
    const over=pickOU(mkTotals,"over"), under=pickOU(mkTotals,"under");
    g.appendChild(od("Over 2.5", over)); g.appendChild(od("Under 2.5", under)); box.appendChild(g);
  }
}
function od(label,val){ const e=document.createElement("div"); e.className="od"; e.innerHTML=`<strong>${label}</strong><span>${val?.price??"—"} <span class="tiny">${val?.book? "· "+val.book:""}</span></span>`; return e; }
function pickLeg(mk,side){ const o=mk.best||mk.h2h||mk.data||mk; return o[side]||(o.outcomes||[]).find(x=>(x.name||"").toLowerCase().includes(side)); }
function pickOU(mk,side){ const o=mk.best||mk.totals||mk.data||mk; const outs=o.outcomes||[]; return outs.find(x=>(x.name||"").toLowerCase().includes(side) && String(x.point??"").includes("2.5")) || o[side]; }

/* NEWS con manejo de errores */
async function loadNews(home,away){
  const list=$("#newsList"); list.innerHTML=`<div class="tiny">Buscando noticias…</div>`;
  try{
    const u=new URL(WORKER+"/news"); u.searchParams.set("home",home); u.searchParams.set("away",away); u.searchParams.set("lang",LANG); u.searchParams.set("gl",GL); u.searchParams.set("ceid",CEID);
    const response = await fetch(u);
    if (!response.ok) throw new Error("Error en noticias: " + response.status);
    const data=await response.json(); const items=Array.isArray(data)?data:(data.items||[]);
    list.innerHTML=""; if(!items.length){ list.innerHTML=`<div class="tiny">Sin noticias por ahora.</div>`; return; }
    items.slice(0,6).forEach(it=>{
      const div=document.createElement("div"); div.className="item";
      const src=it.source?` · <span class="tiny">${it.source}</span>`:"";
      div.innerHTML=`<strong>${(it.title||"").replace(/&amp;/g,"&")}</strong><div class="tiny">${new Date(it.pubDate).toLocaleString("es-ES")}${src}</div>`;
      div.onclick=()=> window.open(it.link,"_blank","noopener"); list.appendChild(div);
    });
    $("#refreshNews").onclick=(e)=>{ e.preventDefault(); loadNews(home, away); };
  }catch(e){ 
    console.error("Error cargando noticias:", e);
    list.innerHTML=`<div class="tiny">No se pudo cargar noticias.</div>`; 
  }
}

/* PAST con manejo de errores */
async function loadPast(teamId=state.teamId){
  showSpinner(true);
  const box=$("#pastList"); box.innerHTML="";
  try {
    const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","FINISHED"); u.searchParams.set("include_tv","0");
    const response = await fetch(u);
    if (!response.ok) throw new Error("Error en pasados: " + response.status);
    const data=await response.json(); const arr=(data.matches||[]).slice(-12).reverse();
    if(!arr.length){ box.innerHTML=`<div class="tiny">No hay registros recientes.</div>`; showSpinner(false); return; }
    arr.forEach(m=>{
      const hs=m.score?.fullTime?.home ?? m.score?.regularTime?.home ?? "–";
      const as=m.score?.fullTime?.away ?? m.score?.regularTime?.away ?? "–";
      const {d,t}=parts(m.utcDate);
      const acc=document.createElement("div"); acc.className="acc";
      const head=document.createElement("div"); head.className="row"; head.innerHTML=`<strong>${m.homeTeam?.name} ${hs}-${as} ${m.awayTeam?.name}</strong><span class="tiny">${d} · ${t}</span>`;
      const det=document.createElement("div"); det.className="details tiny";
      det.innerHTML = [
        `<div><b>Competición:</b> ${m.competition?.name||"—"}</div>`,
        `<div><b>Estado:</b> ${m.status||"FINISHED"}</div>`,
        `<div><b>Goleadores:</b> no disponibles</div>`
      ].join("");
      head.onclick=()=> acc.classList.toggle("open");
      acc.appendChild(head); acc.appendChild(det); box.appendChild(acc);
    });
  } catch(e) {
    console.error("Error cargando pasados:", e);
    box.innerHTML=`<div class="tiny">Error al cargar partidos pasados.</div>`;
  } finally {
    showSpinner(false);
  }
}

/* LIVE con manejo de errores */
async function loadLive(teamId=state.teamId){
  showSpinner(true);
  const box=$("#liveList"); box.innerHTML="";
  try {
    const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","LIVE"); u.searchParams.set("include_tv","1");
    const response = await fetch(u);
    if (!response.ok) throw new Error("Error en live: " + response.status);
    const data=await response.json(); const arr=data.matches||[];
    if(!arr.length){ box.innerHTML=`<div class="tiny">Nada en vivo ahora mismo.</div>`; showSpinner(false); return; }
    arr.forEach(m=>{
      const hs=m.score?.fullTime?.home ?? m.score?.halfTime?.home ?? "–";
      const as=m.score?.fullTime?.away ?? m.score?.halfTime?.away ?? "–";
      const r=document.createElement("div"); r.className="row";
      r.innerHTML=`<strong>${m.homeTeam?.name} ${hs}-${as} ${m.awayTeam?.name}</strong><span class="tiny">${m.status||"LIVE"}</span>`;
      box.appendChild(r);
    });
  } catch(e) {
    console.error("Error cargando live:", e);
    box.innerHTML=`<div class="tiny">Error al cargar partidos en vivo.</div>`;
  } finally {
    showSpinner(false);
  }
}

/* TABLE con chart generado y manejo de errores */
async function loadStandings(){
  showSpinner(true);
  const chart=$("#chart"); chart.innerHTML="";
  try {
    const response = await fetch(WORKER+"/standings");
    if (!response.ok) throw new Error("Error en standings: " + response.status);
    const data=await response.json(); const rows=(data?.standings?.[0]?.table)||[];
    $("#tableUpdated").textContent=new Date().toLocaleString("es-ES");
    if(!rows.length){ chart.innerHTML=`<div class="tiny">Sin datos</div>`; showSpinner(false); return; }
    const maxPoints = Math.max(...rows.map(r => r.points));
    rows.forEach(r => {
      const bar = document.createElement("div"); bar.className = "chart-bar";
      bar.style.width = `${(r.points / maxPoints) * 100}%`;
      bar.dataset.label = `${r.team?.name} - ${r.points} pts`;
      if (String(r.team?.id) === "81") bar.style.background = "linear-gradient(to right, var(--ok), var(--brand))";
      chart.appendChild(bar);
    });
  } catch(e) {
    console.error("Error cargando standings:", e);
    chart.innerHTML=`<div class="tiny">Error al cargar clasificación.</div>`;
  } finally {
    showSpinner(false);
  }
}

/* CALENDAR con manejo de errores */
async function loadCalendar(teamId=state.teamId){
  showSpinner(true);
  const wrap=$("#calWrap"); wrap.innerHTML="";
  try {
    const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","SCHEDULED"); u.searchParams.set("include_tv","0");
    const response = await fetch(u);
    if (!response.ok) throw new Error("Error en calendario: " + response.status);
    const data=await response.json(); const arr=(data.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
    if(!arr.length){ wrap.innerHTML=`<div class="tiny">No hay próximos partidos programados.</div>`; showSpinner(false); return; }
    const byMonth = {};
    arr.forEach(m=>{ const d=new Date(m.utcDate); const key=d.toLocaleDateString("es-ES",{month:"long", year:"numeric"}); (byMonth[key]=byMonth[key]||[]).push(m); });
    Object.entries(byMonth).forEach(([mon, list])=>{
      const h=document.createElement("div"); h.className="month"; h.textContent=mon; wrap.appendChild(h);
      list.forEach(m=>{
        const {d,t}=parts(m.utcDate);
        const row=document.createElement("div"); row.className="cal-item";
        const left=`<strong>${m.homeTeam?.name} vs ${m.awayTeam?.name}</strong><div class="tiny">${d} · ${t} · ${m.competition?.name||""}</div>`;
        const btn=document.createElement("button"); btn.className="pill"; btn.textContent="ICS";
        btn.onclick=()=> saveICS(m);
        row.innerHTML=left; row.appendChild(btn); wrap.appendChild(row);
      });
    });
  } catch(e) {
    console.error("Error cargando calendario:", e);
    wrap.innerHTML=`<div class="tiny">Error al cargar calendario.</div>`;
  } finally {
    showSpinner(false);
  }
}
function saveICS(m){
  const start=new Date(m.utcDate), end=new Date(start.getTime()+2*60*60*1000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tracker//ES
BEGIN:VEVENT
DTSTAMP:${fmt(new Date())}
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
SUMMARY:${m.homeTeam?.name} vs ${m.awayTeam?.name}
DESCRIPTION:${m.competition?.name||"Fútbol"} - Generado por Tracker
END:VEVENT
END:VCALENDAR`.replace(/\n/g,"\r\n");
  const url=URL.createObjectURL(new Blob([ics],{type:"text/calendar"})); const a=document.createElement("a"); a.href=url; a.download="partido.ics"; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* Notifications */
$("#notifyBtn").onclick=async()=>{
  if(!window.Notification) return alert("Tu navegador no soporta notificaciones.");
  const perm=await Notification.requestPermission(); if(perm!=="granted") return;
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",state.teamId); u.searchParams.set("status","SCHEDULED");
  const next=(await (await fetch(u)).json()).matches?.filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
  if(!next) return alert("Aún no hay partido programado.");
  const t0=new Date(next.utcDate).getTime(), now=Date.now();
  function fire(ms,msg){ setTimeout(()=> new Notification("Tracker",{body:msg}), ms); }
  if(t0-now>10*60*1000) fire(t0-now-10*60*1000,"El partido empieza en 10 minutos.");
  if(t0-now>0) fire(t0-now,"¡Rueda el balón!");
  alert("Recordatorios configurados.");
};

/* Teams – LaLiga rápida */
const TEAM_MAP={"FC Barcelona":"81","Real Madrid CF":"86","Atlético de Madrid":"78","Athletic Bilbao":"77","Real Sociedad":"92","Villarreal CF":"94","Real Betis":"90","Valencia CF":"95","Sevilla FC":"559","RC Celta de Vigo":"558","RCD Espanyol de Barcelona":"80","Getafe CF":"82","CA Osasuna":"79","Deportivo Alavés":"263","Girona FC":"298","UD Las Palmas":"275","Rayo Vallecano":"87","RCD Mallorca":"1041","CD Leganés":"745","Real Valladolid CF":"250"};
function renderTeams(){
  const chips=$("#leagueList"); chips.innerHTML="";
  Object.entries(TEAM_MAP).forEach(([name,id])=>{ const b=document.createElement("div"); b.className="pill"; b.textContent=name; b.onclick=()=>{state.teamId=id; localStorage.setItem("teamId",id); switchTab("next"); loadNext(id);} ; chips.appendChild(b);});
  $("#teamSearch").oninput=(e)=>{ const q=e.target.value.toLowerCase(); $$("#leagueList .pill").forEach(b=> b.style.display=b.textContent.toLowerCase().includes(q)?"":"none"); };
}

/* PWA: manifest + install prompt */
(function(){
  const manifest={name:"Tracker",short_name:"Tracker",display:"standalone",theme_color:"#0a0d14",background_color:"#0a0d14",start_url:"./",icons:[{src:"icon-192.png",sizes:"192x192",type:"image/png"},{src:"icon-512.png",sizes:"512x512",type:"image/png"}]};
  const url=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:"application/json"}));
  const link=document.createElement("link"); link.rel="manifest"; link.href=url; document.head.appendChild(link);
  const sw=`self.addEventListener("install",e=>self.skipWaiting()); self.addEventListener("activate",e=>e.waitUntil(self.clients.claim()));`;
  if("serviceWorker" in navigator){ navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:"text/javascript"}))).catch(()=>{}); }

  window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); state.deferredPrompt=e; $("#installBtn").classList.remove("hidden"); });
  $("#installBtn").onclick=async()=>{ if(state.deferredPrompt){ state.deferredPrompt.prompt(); state.deferredPrompt=null; $("#installBtn").classList.add("hidden"); } };
})();

/* Init */
(async function init(){ renderTeams(); switchTab("next"); await loadNext(state.teamId); })();
$$(".bn button, .tabs [data-tab]").forEach(b=> b.onclick=()=> switchTab(b.dataset.tab));
</script>
</body>
</html>