<!doctype html>
<html lang="es" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Equipo Tracker — SAFE</title>
    <meta name="theme-color" content="#0b0d10" />
    <meta name="api-base" content="https://test.christiansanabria.workers.dev/">
    <style>
      :root { --bg:#0b0d10; --bg-elev:#11151a; --card:#131821; --text:#e8ecf1; --muted:#a9b4c0; --brand:#4da3ff; --border:#1c2430; --shadow:rgba(0,0,0,.25); --radius:20px; }
      html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;background:var(--bg);color:var(--text)}
      *,*:before,*:after{box-sizing:border-box} img{max-width:100%;display:block} a{color:inherit;text-decoration:none}
      .app-header{position:sticky;top:0;z-index:40;background:#0e1217;border-bottom:1px solid var(--border)}
      .app-header .inner{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:12px 16px;max-width:880px;margin:0 auto}
      .brand{display:flex;align-items:center;gap:12px} .brand .crest{width:36px;height:36px;border-radius:50%;background:#11151a}
      h1{font-size:18px;margin:0} .sub{font-size:12px;color:var(--muted)} .filters{display:flex;gap:8px;align-items:center}
      select{font:inherit;color:inherit;background:var(--bg-elev);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
      main{padding:14px 16px 88px;max-width:880px;margin:0 auto}
      .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 24px var(--shadow);padding:14px;margin-bottom:12px}
      .list{display:grid;gap:8px}
      .row{display:flex;gap:12px;align-items:center}
      .chip{font-size:12px;padding:6px 8px;border:1px solid var(--border);background:#0e1217;border-radius:999px;display:inline-block;margin-right:6px;margin-top:6px}
      .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:50;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:8px 10px;background:#0e1217}
      .tabbar button{height:54px;border-radius:14px;color:#c7d0db}
      .fab{position:fixed;right:16px;bottom:72px;z-index:60;width:56px;height:56px;border-radius:18px;background:var(--brand);color:#fff;border:0}
      .error{position:sticky;top:0;z-index:100;background:#3b1f1f;color:#ffdede;padding:8px 12px;border-bottom:1px solid #5a2c2c;font-size:13px}
    </style>
    <link rel="stylesheet" href="skin.css">
  </head>
  <body>
    <div id="error" class="error" hidden></div>
    <header class="app-header" role="banner">
      <div class="inner">
        <div class="brand">
          <div class="crest" aria-hidden="true"></div>
          <div>
            <h1>Equipo Tracker</h1>
            <div class="sub">Calendario · TV · Noticias</div>
          </div>
        </div>
        <div class="filters">
          <select id="teamSelect" aria-label="Equipo"></select>
          <select id="country" aria-label="País"></select>
          <select id="status" aria-label="Estado"></select>
        </div>
      </div>
    </header>

    <main>
      <section id="view-matches">
        <div id="matchesContainer" class="list" aria-live="polite"></div>
      </section>
    </main>

    <button class="fab" id="btn-refresh" aria-label="Actualizar">↻</button>

    <nav class="tabbar">
      <button data-tab="matches">Partidos</button>
      <button data-tab="news">Noticias</button>
      <button data-tab="standings">Clasificación</button>
      <button data-tab="stats">Stats</button>
    </nav>

    <script>
      (function(){
        var meta = document.querySelector('meta[name="api-base"]');
        var API_BASE = meta && meta.content ? meta.content.replace(/\/$/, '') : '';
        var state = { teamId: undefined, country: 'ES', status: 'all' };
        var matchesEl = document.getElementById('matchesContainer');
        var errEl = document.getElementById('error');

        function showError(msg){
          errEl.textContent = 'Error · ' + msg + ' · API_BASE=' + API_BASE;
          errEl.hidden = false;
          console.error(msg);
        }
        function el(tag, attrs, children){
          var e = document.createElement(tag);
          if (attrs) for (var k in attrs){
            if (k === 'class') e.className = attrs[k];
            else if (k === 'text') e.textContent = attrs[k];
            else e.setAttribute(k, attrs[k]);
          }
          if (children) children.forEach(function(c){ if (typeof c === 'string') e.appendChild(document.createTextNode(c)); else if (c) e.appendChild(c); });
          return e;
        }
        function qs(url, params){
          var u = new URL(url, API_BASE || location.origin);
          Object.keys(params||{}).forEach(function(k){
            var v = params[k];
            if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
          });
          return u.toString();
        }
        function getJSON(url){
          return fetch(url, { headers: { accept: 'application/json' } }).then(function(r){
            if(!r.ok) throw new Error('HTTP '+r.status+' en '+url);
            return r.json();
          });
        }

        function setSkeleton(n){
          matchesEl.innerHTML = '';
          for (var i=0;i<n;i++) matchesEl.appendChild(el('div',{class:'card'},[el('div',{class:'row'},[el('div',{class:'chip',text:'···'} )])]));
        }

        function renderMatchesList(data){
          matchesEl.innerHTML = '';
          if (!data || !data.matches || !data.matches.length){
            matchesEl.appendChild(el('div',{class:'card'},['No hay partidos disponibles.']));
            return;
          }
          // Hero
          var m0 = data.matches[0];
          matchesEl.appendChild(matchHero(m0));
          // Resto
          for (var i=1;i<data.matches.length;i++){
            matchesEl.appendChild(matchRow(data.matches[i]));
          }
        }

        function matchHero(m){
          var card = el('div',{class:'card'});
          var row = el('div',{class:'row'});
          var home = el('div',null,[
            el('img',{alt:(m.home && m.home.name) || 'Local', src:(m.home && m.home.crest) || '', width:'48', height:'48'}),
            el('div',{class:'chip',text:(m.home && m.home.name) || 'Local'})
          ]);
          var vs = el('div',{class:'chip',text:(m.score || 'VS')});
          var away = el('div',null,[
            el('img',{alt:(m.away && m.away.name) || 'Visitante', src:(m.away && m.away.crest) || '', width:'48', height:'48'}),
            el('div',{class:'chip',text:(m.away && m.away.name) || 'Visitante'})
          ]);
          row.appendChild(home); row.appendChild(vs); row.appendChild(away);
          card.appendChild(row);

          var chips = el('div',null,[]);
          if (m.round) chips.appendChild(el('span',{class:'chip',text:m.round}));
          if (m.venue) chips.appendChild(el('span',{class:'chip',text:m.venue}));
          if (m.tv && m.tv.length) for (var i=0;i<m.tv.length;i++) chips.appendChild(el('span',{class:'chip',text:m.tv[i]}));
          card.appendChild(chips);
          return card;
        }

        function matchRow(m){
          var card = el('div',{class:'card'});
          var row = el('div',{class:'row'});
          row.appendChild(el('img',{alt:(m.home && m.home.name) || 'H', src:(m.home && m.home.crest) || '', width:'32', height:'32'}));
          var right = el('div',null,[]);
          right.appendChild(el('div',{text: ((m.home && m.home.name) || 'Local') + ' vs ' + ((m.away && m.away.name) || 'Visitante') }));
          if (m.date) right.appendChild(el('div',{class:'chip',text: new Date(m.date).toLocaleString()}));
          if (m.tv && m.tv.length) right.appendChild(el('div',{class:'chip',text: m.tv.join(', ')}));
          row.appendChild(right);
          card.appendChild(row);
          return card;
        }

        function fillFiltersFromMatches(data){
          var teams = new Map();
          (data.matches || []).forEach(function(m){
            if (m.home && m.home.id) teams.set(String(m.home.id), m.home.name || 'Equipo');
            if (m.away && m.away.id) teams.set(String(m.away.id), m.away.name || 'Equipo');
          });
          var teamSelect = document.getElementById('teamSelect');
          teamSelect.innerHTML = '';
          teamSelect.appendChild(el('option',{value:''},['Equipo']));
          teams.forEach(function(name, id){
            teamSelect.appendChild(el('option',{value:id},[name]));
          });
        }

        function load(){
          setSkeleton(3);
          getJSON(qs('/matches', { team: state.teamId, country: state.country, status: state.status }))
            .then(function(data){ fillFiltersFromMatches(data); renderMatchesList(data); })
            .catch(function(e){ showError(e.message); matchesEl.innerHTML = ''; matchesEl.appendChild(el('div',{class:'card'},['Error al cargar partidos: ' + e.message])); });
        }

        document.getElementById('teamSelect').addEventListener('change', function(e){ state.teamId = e.target.value || undefined; load(); });
        document.getElementById('country').innerHTML = ['ES','US','UK','FR','DE','IT'].map(function(c){ return '<option'+(c===state.country?' selected':'')+'>'+c+'</option>'; }).join('');
        document.getElementById('status').innerHTML = ['all','live','finished','scheduled'].map(function(s){ return '<option'+(s===state.status?' selected':'')+'>'+s+'</option>'; }).join('');
        document.getElementById('status').addEventListener('change', function(e){ state.status = e.target.value; load(); });
        document.getElementById('country').addEventListener('change', function(e){ state.country = e.target.value; load(); });
        document.getElementById('btn-refresh').addEventListener('click', load);

        // health check para diagnosticar
        getJSON(qs('/health', {})).catch(function(e){ showError('Health: ' + e.message); }).finally(load);
      })();
    </script>
  </body>
</html>
