<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barça Tracker Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ------------------------- */
        /* --- VARIABLES Y TEMAS --- */
        /* ------------------------- */
        :root {
            --font-main: 'Inter', sans-serif;
            
            /* Tema Claro (Default) */
            --bg-color: #f0f2f5;
            --bg-image: linear-gradient(135deg, #eef2f8 0%, #dbe6f2 100%);
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border-color: rgba(255, 255, 255, 0.9);
            --text-color-primary: #1a202c;
            --text-color-secondary: #4a5568;
            --text-color-accent: #004d98; /* Barça Blue */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glow-color-1: rgba(237, 22, 79, 0.6); /* Barça Garnet */
            --glow-color-2: rgba(0, 77, 152, 0.6); /* Barça Blue */
            --glow-color-3: rgba(66, 153, 225, 0.7); /* Info Blue */
            --skeleton-bg: #e2e8f0;
            --skeleton-highlight: #f7fafc;
        }

        body.dark-mode {
            /* Tema Oscuro */
            --bg-color: #12121c;
            --bg-image: linear-gradient(135deg, #1a1a2e 0%, #10101a 100%);
            --card-bg: rgba(26, 32, 44, 0.6);
            --card-border-color: rgba(255, 255, 255, 0.1);
            --text-color-primary: #edf2f7;
            --text-color-secondary: #a0aec0;
            --text-color-accent: #90cdf4;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --glow-color-1: rgba(237, 22, 79, 0.8);
            --glow-color-2: rgba(0, 77, 152, 0.8);
            --glow-color-3: rgba(66, 153, 225, 0.8);
            --skeleton-bg: #2d3748;
            --skeleton-highlight: #4a5568;
        }

        /* ------------------------- */
        /* --- ESTILOS BASE --- */
        /* ------------------------- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* ------------------------- */
        /* --- LAYOUT PRINCIPAL --- */
        /* ------------------------- */
        .dashboard-header { padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-title { font-size: 1.75rem; font-weight: 900; color: var(--text-color-accent); }
        .main-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; padding: 0 2rem 2rem 2rem; max-width: 1600px; margin: 0 auto; }

        /* ------------------------- */
        /* --- ESTILO DE TARJETAS (CARD) --- */
        /* ------------------------- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--card-border-color);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 var(--shadow-color); }
        .card-title { font-size: 1.25rem; font-weight: 700; border-bottom: 2px solid var(--text-color-accent); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }

        /* ------------------------- */
        /* --- SKELETON LOADER --- */
        /* ------------------------- */
        .skeleton { background-color: var(--skeleton-bg); border-radius: 8px; position: relative; overflow: hidden; }
        .skeleton::before { content: ''; position: absolute; top: 0; left: -150px; height: 100%; width: 150px; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-shimmer 1.5s infinite; }
        @keyframes skeleton-shimmer { 0% { left: -150px; } 100% { left: 100%; } }
        .skeleton-text { height: 1em; margin-bottom: 0.5em; }
        .skeleton-title { height: 1.5em; width: 60%; margin-bottom: 1em; }
        .skeleton-avatar { width: 60px; height: 60px; border-radius: 50%; }
        .skeleton-line { height: 2.5em; margin-bottom: 0.75rem; }

        /* ------------------------- */
        /* --- COMPONENTES ESPECÍFICOS --- */
        /* ------------------------- */

        /* Próximo Partido Principal */
        #next-match-card { grid-column: 1 / -1; }
        .match-teams { display: flex; justify-content: space-around; align-items: center; text-align: center; }
        .team { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .team-logo { width: 80px; height: 80px; object-fit: contain; }
        .team-name { font-weight: 600; font-size: 1.1rem; }
        .vs { font-size: 2.5rem; font-weight: 900; color: var(--text-color-accent); }
        .match-details { text-align: center; color: var(--text-color-secondary); }
        .match-date { font-size: 1.2rem; font-weight: 600; }
        .match-competition { font-size: 1rem; }
        
        .info-pills { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
        .pill { padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; color: white; }
        .pill.tv { background-color: var(--glow-color-1); }
        .pill.odds { background-color: var(--glow-color-2); }
        .pill.days { background-color: var(--glow-color-3); }

        /* Clasificación */
        #standings-card { grid-column: 1 / -1; } /* Ocupa todo el ancho */
        .standings-table-container { max-height: 400px; overflow-y: auto; }
        .standings-table { width: 100%; border-collapse: collapse; }
        .standings-table th, .standings-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--card-border-color); }
        .standings-table th { font-weight: 600; color: var(--text-color-secondary); position: sticky; top: 0; background: var(--card-bg); backdrop-filter: blur(5px); }
        .standings-table td.pos { font-weight: 700; text-align: center; }
        .standings-table .numeric-col { text-align: center; font-variant-numeric: tabular-nums; }
        .standings-table tr:last-child td { border-bottom: none; }
        .standings-table tr.highlight { font-weight: 700; background-color: rgba(0, 77, 152, 0.1); }
        .standings-table .team-name-col { display: flex; align-items: center; gap: 0.75rem; }
        .team-logo-img-small { width: 24px; height: 24px; object-fit: contain; }

        /* Noticias */
        .news-list a { text-decoration: none; color: inherit; }
        .news-item { padding: 1rem; border-radius: 12px; transition: background-color 0.2s ease; border: 1px solid transparent; }
        .news-item:hover { background-color: rgba(0,0,0,0.05); border-color: var(--card-border-color); }
        body.dark-mode .news-item:hover { background-color: rgba(255,255,255,0.05); }
        .news-title { font-weight: 600; margin-bottom: 0.25rem; }
        .news-source { font-size: 0.8rem; color: var(--text-color-secondary); }

        /* Próximos Partidos (Lista) */
        .upcoming-list { list-style: none; display: flex; flex-direction: column; gap: 1rem; }
        .upcoming-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 12px; transition: background-color 0.2s ease; }
        .upcoming-item:hover { background-color: rgba(0,0,0,0.03); }
        body.dark-mode .upcoming-item:hover { background-color: rgba(255,255,255,0.03); }
        .upcoming-teams { display: flex; align-items: center; gap: 0.5rem; }
        .team-logo-img-list { width: 28px; height: 28px; object-fit: contain; }
        .upcoming-info { display: flex; flex-direction: column; }
        .upcoming-date { font-weight: 600; font-size: 0.9rem; }
        .upcoming-competition { font-size: 0.8rem; color: var(--text-color-secondary); }
        .upcoming-countdown { font-size: 0.8rem; font-weight: 600; color: var(--text-color-secondary); text-align: right; }
        .pill-tv-small { background-color: var(--glow-color-1); color: white; font-size: 0.75rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 10px; }

        /* Theme Toggle */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 20px; left: 2px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-color-accent); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .dashboard-header { flex-direction: column; gap: 1rem; text-align: center; }
            .main-container { padding: 0 1rem 1rem 1rem; grid-template-columns: 1fr; }
            .team-logo { width: 60px; height: 60px; }
            .vs { font-size: 1.8rem; }
            .team-name { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <h1 class="dashboard-title">Barça Tracker</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </header>

    <main class="main-container">
        <!-- Tarjeta del Próximo Partido -->
        <section class="card" id="next-match-card">
            <div id="next-match-loader">
                <div class="skeleton skeleton-title"></div>
                <div style="display: flex; justify-content: space-around; align-items: center;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton skeleton-text" style="width: 20%;"></div>
                    <div class="skeleton skeleton-avatar"></div>
                </div>
                <div class="skeleton skeleton-line" style="width: 80%; margin: 1rem auto 0;"></div>
            </div>
            <div id="next-match-content" style="display: none;"></div>
        </section>

        <!-- Tarjeta de Próximos Partidos -->
        <section class="card" id="upcoming-matches-card">
            <h2 class="card-title">Próximos Partidos</h2>
            <div id="upcoming-matches-loader">
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
            </div>
            <div id="upcoming-matches-content" style="display: none;"></div>
        </section>
        
        <!-- Tarjeta de Noticias -->
        <section class="card" id="news-card">
            <h2 class="card-title">Últimas Noticias (Previa)</h2>
            <div id="news-loader">
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
            </div>
            <div id="news-content" style="display: none;"></div>
        </section>

        <!-- Tarjeta de Clasificación -->
        <section class="card" id="standings-card">
            <h2 class="card-title">Clasificación LaLiga</h2>
            <div id="standings-loader">
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
                <div class="skeleton skeleton-line"></div>
            </div>
            <div id="standings-content" style="display: none;"></div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const WORKER_BASE_URL = 'https://test.christiansanabria.workers.dev';
            const BARCELONA_TEAM_ID = '81';

            const themeToggle = document.getElementById('checkbox');
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }
            themeToggle.addEventListener('change', function() {
                document.body.classList.toggle('dark-mode', this.checked);
                localStorage.setItem('theme', this.checked ? 'dark' : 'light');
            });

            // --- HELPERS ---
            const formatDate = (d) => new Date(d).toLocaleString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const formatDateSimple = (d) => new Date(d).toLocaleString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }).replace('.', '');
            
            const getDaysRemaining = (dateString) => {
                const today = new Date();
                const matchDate = new Date(dateString);
                today.setHours(0, 0, 0, 0);
                matchDate.setHours(0, 0, 0, 0);
                const diffTime = matchDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) return 'Finalizado';
                if (diffDays === 0) return 'Hoy';
                if (diffDays === 1) return 'Mañana';
                return `Faltan ${diffDays} días`;
            };

            const showContent = (loaderId, contentId) => {
                const loader = document.getElementById(loaderId);
                const content = document.getElementById(contentId);
                if (loader) loader.style.display = 'none';
                if (content) content.style.display = 'block';
            };
            
            const showError = (contentId, message) => {
                const content = document.getElementById(contentId);
                if(content) content.innerHTML = `<p style="color: var(--text-color-secondary); text-align: center;">${message}</p>`;
            };

            // --- FUNCIONES DE FETCH ---
            
            async function fetchAllMatches() {
                try {
                    const response = await fetch(`${WORKER_BASE_URL}/matches?team=${BARCELONA_TEAM_ID}&status=SCHEDULED&include_tv=1`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (!data.matches || data.matches.length === 0) {
                        showError('next-match-content', 'No hay partidos programados.');
                        showError('upcoming-matches-content', 'No hay partidos programados.');
                        showError('news-content', 'No hay partidos para buscar noticias.');
                        showContent('next-match-loader', 'next-match-content');
                        showContent('upcoming-matches-loader', 'upcoming-matches-content');
                        showContent('news-loader', 'news-content');
                        return;
                    }

                    const nextMatch = data.matches[0];
                    const upcomingMatches = data.matches.slice(1, 6);

                    renderNextMatch(nextMatch);
                    renderUpcomingMatches(upcomingMatches);
                    
                    fetchNews(nextMatch.homeTeam.name, nextMatch.awayTeam.name);
                    fetchOddsForMatch(nextMatch.homeTeam.name, nextMatch.awayTeam.name);

                } catch (error) {
                    console.error('Error fetching matches:', error);
                    showError('next-match-content', 'No se pudo cargar la información de los partidos.');
                    showError('upcoming-matches-content', 'No se pudo cargar la información de los partidos.');
                } finally {
                    showContent('next-match-loader', 'next-match-content');
                    showContent('upcoming-matches-loader', 'upcoming-matches-content');
                }
            }

            async function fetchOddsForMatch(home, away) {
                try {
                    const response = await fetch(`${WORKER_BASE_URL}/odds?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&markets=1x2`);
                    if (!response.ok) return;
                    const oddsData = await response.json();
                    if (oddsData && !oddsData.error && oddsData.length > 0) {
                        renderOdds(oddsData);
                    }
                } catch (error) {
                    console.error('Error fetching odds:', error);
                }
            }
            
            async function fetchStandings() {
                try {
                    const response = await fetch(`${WORKER_BASE_URL}/standings`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.message);
                    renderStandings(data);
                } catch (error) {
                    console.error('Error fetching standings:', error);
                    showError('standings-content', 'No se pudo cargar la clasificación.');
                } finally {
                    showContent('standings-loader', 'standings-content');
                }
            }

            async function fetchNews(home, away) {
                 try {
                    const response = await fetch(`${WORKER_BASE_URL}/news?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.message);
                    renderNews(data);
                } catch (error) {
                    console.error('Error fetching news:', error);
                    showError('news-content', 'No se pudieron cargar las noticias.');
                } finally {
                    showContent('news-loader', 'news-content');
                }
            }

            // --- FUNCIONES DE RENDER ---

            function renderNextMatch(match) {
                const container = document.getElementById('next-match-content');
                
                let tvHtml = '';
                if (match.tv && match.tv.channels && match.tv.channels.length > 0) {
                    tvHtml = `<div class="pill tv">📺 ${match.tv.channels.join(', ')}</div>`;
                }

                const daysHtml = `<div class="pill days">🗓️ ${getDaysRemaining(match.utcDate)}</div>`;

                container.innerHTML = `
                    <div class="match-teams">
                        <div class="team">
                            <img src="${match.homeTeam.crest}" alt="Escudo de ${match.homeTeam.name}" class="team-logo">
                            <span class="team-name">${match.homeTeam.name}</span>
                        </div>
                        <span class="vs">VS</span>
                        <div class="team">
                            <img src="${match.awayTeam.crest}" alt="Escudo de ${match.awayTeam.name}" class="team-logo">
                            <span class="team-name">${match.awayTeam.name}</span>
                        </div>
                    </div>
                    <div class="match-details">
                        <p class="match-date">${formatDate(match.utcDate)}</p>
                        <p class="match-competition">${match.competition.name}</p>
                    </div>
                    <div class="info-pills" id="next-match-pills">
                        ${daysHtml}
                        ${tvHtml}
                    </div>
                `;
            }

            function renderOdds(oddsData) {
                const pillsContainer = document.getElementById('next-match-pills');
                if (!pillsContainer) return;

                const market1x2 = oddsData.find(o => o.market === '1x2');
                if (market1x2) {
                    const homeOdd = market1x2.outcomes.find(o => o.name === 'Local')?.best || '?';
                    const drawOdd = market1x2.outcomes.find(o => o.name === 'Empate')?.best || '?';
                    const awayOdd = market1x2.outcomes.find(o => o.name === 'Visitante')?.best || '?';
                    const oddsHtml = `<div class="pill odds">📊 1: ${homeOdd} | X: ${drawOdd} | 2: ${awayOdd}</div>`;
                    pillsContainer.innerHTML += oddsHtml;
                }
            }
            
            function renderStandings(data) {
                const tableBody = data?.standings?.[0]?.table;
                if (!tableBody) {
                    showError('standings-content', 'Formato de datos de clasificación no válido.');
                    return;
                }
                const container = document.getElementById('standings-content');
                
                container.innerHTML = `
                    <div class="standings-table-container">
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th class="pos">#</th>
                                    <th>Equipo</th>
                                    <th class="numeric-col">PJ</th>
                                    <th class="numeric-col">V</th>
                                    <th class="numeric-col">E</th>
                                    <th class="numeric-col">D</th>
                                    <th class="numeric-col">DG</th>
                                    <th class="numeric-col">Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableBody.map(row => `
                                    <tr class="${row.team.id == BARCELONA_TEAM_ID ? 'highlight' : ''}">
                                        <td class="pos">${row.position}</td>
                                        <td class="team-name-col">
                                            <img src="${row.team.crest}" alt="${row.team.name}" class="team-logo-img-small">
                                            ${row.team.name}
                                        </td>
                                        <td class="numeric-col">${row.playedGames}</td>
                                        <td class="numeric-col">${row.won}</td>
                                        <td class="numeric-col">${row.draw}</td>
                                        <td class="numeric-col">${row.lost}</td>
                                        <td class="numeric-col">${row.goalDifference}</td>
                                        <td class="numeric-col"><strong>${row.points}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function renderNews(data) {
                if (!data.items || data.items.length === 0) {
                    showError('news-content', 'No hay noticias disponibles en este momento.');
                    return;
                }
                const container = document.getElementById('news-content');
                container.innerHTML = `
                    <div class="news-list">
                        ${data.items.slice(0, 3).map(item => `
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer">
                                <article class="news-item">
                                    <h3 class="news-title">${item.title}</h3>
                                    <p class="news-source">${item.source}</p>
                                </article>
                            </a>
                        `).join('')}
                    </div>
                `;
            }

            function renderUpcomingMatches(matches) {
                const container = document.getElementById('upcoming-matches-content');
                if (!matches || matches.length === 0) {
                    showError('upcoming-matches-content', 'No hay más partidos programados después del siguiente.');
                    return;
                }

                container.innerHTML = `
                    <ul class="upcoming-list">
                        ${matches.map(match => `
                            <li class="upcoming-item">
                                <div class="upcoming-teams">
                                    <img src="${match.homeTeam.crest}" alt="${match.homeTeam.name}" class="team-logo-img-list">
                                    <span>vs</span>
                                    <img src="${match.awayTeam.crest}" alt="${match.awayTeam.name}" class="team-logo-img-list">
                                </div>
                                <div class="upcoming-info">
                                    <span class="upcoming-date">${formatDateSimple(match.utcDate)}</span>
                                    <span class="upcoming-competition">${match.competition.name}</span>
                                </div>
                                <div class="upcoming-countdown">
                                    ${getDaysRemaining(match.utcDate)}
                                    ${match.tv && match.tv.channels.length > 0 ? `<div class="pill-tv-small" style="margin-top: 4px;">📺</div>` : ''}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }

            // --- INICIALIZACIÓN ---
            function init() {
                fetchAllMatches();
                fetchStandings();
            }

            init();
        });
    </script>
</body>
</html>