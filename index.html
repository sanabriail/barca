<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tracker</title>
<meta name="theme-color" content="#0a0d14">
<style>
  @font-face { font-family: 'Inter'; src: url('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2') format('woff2'); font-weight: 1 1000; font-style: normal; font-display: swap; }
  :root {
    --bg: #f6f8ff; --bg2: #e9edff; --card: rgba(255,255,255,0.8); --ink: #0d1230; --muted: #5c637a; --ring: #e5e9ff;
    --brand: #3b6cff; --brand2: #8b5cf6; --ok: #16a34a; --bad: #ef4444;
    --chip: #eef1ff; --chip-ink: #263fa0; --radius: clamp(12px, 3vw, 18px); --sm: clamp(10px, 2vw, 12px);
    --shadow: 0 14px 40px rgba(15,18,32,.10), 0 2px 8px rgba(15,18,32,.06);
    --glass: blur(20px) saturate(1.5);
  }
  [data-theme="dark"] {
    --bg: #0a0d14; --bg2: #101523; --card: rgba(15,22,41,0.7); --ink: #e9edff; --muted: #96a0bb; --ring: #223056;
    --brand: #7da2ff; --brand2: #b892ff; --chip: #111c33; --chip-ink: #cdd6ff; --shadow: 0 12px 36px rgba(0,0,0,.25), 0 2px 8px rgba(0,0,0,.25);
  }
  @media (prefers-color-scheme: dark) { :root { --bg: #0a0d14; --bg2: #101523; /* etc. */ } }

  * { box-sizing: border-box; transition: all 0.3s ease; }
  html, body { height: 100%; }
  body {
    margin: 0; color: var(--ink); font: 500 clamp(14px, 3.5vw, 16px)/1.5 'Inter', system-ui;
    background: radial-gradient(1200px 600px at 50% -10%, var(--bg2), var(--bg));
    overflow-x: hidden; animation: bgPulse 10s infinite alternate ease-in-out;
  }
  @keyframes bgPulse { 0% { background-position: 50% -10%; } 100% { background-position: 50% -15%; } }
  .app { max-width: 560px; margin: 0 auto; min-height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; }

  /* Header con parallax sutil */
  header { position: sticky; top: 0; z-index: 40; padding: var(--sm) 14px 8px; backdrop-filter: var(--glass); background: linear-gradient(to bottom, color-mix(in oklab, var(--bg) 92%, transparent), transparent); transform: translateY(0); transition: transform 0.5s; }
  .app.scrolled header { transform: translateY(-5px); } /* Parallax simple */
  .topbar { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .brand { display: flex; gap: 10px; align-items: center; }
  .logo { width: 42px; height: 42px; border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; background: linear-gradient(135deg, var(--brand), var(--brand2)); transition: transform 0.3s; }
  .logo:hover { transform: rotate(5deg) scale(1.1); }
  .logo svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
  .title { font-weight: 800; letter-spacing: .2px; }
  .tiny { font-size: var(--sm); color: var(--muted); }

  /* Tabs con underline animado */
  .tabs { display: flex; gap: 8px; overflow: auto; padding: 6px 2px; position: relative; }
  .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--ring); white-space: nowrap; background: transparent; color: var(--ink); position: relative; overflow: hidden; }
  .pill::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--brand); transform: scaleX(0); transition: transform 0.3s; }
  .pill.active::after { transform: scaleX(1); }
  .pill.active { background: var(--ink); color: var(--bg); }
  .pill:hover { filter: brightness(1.1); transform: scale(1.05); }

  /* Screen + cards con glassmorphism */
  .screen { padding: 12px 12px 96px; display: grid; gap: 12px; }
  .card { background: var(--card); border: 1px solid var(--ring); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; backdrop-filter: var(--glass); transition: transform 0.3s, box-shadow 0.3s; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
  .kicker { font-size: var(--sm); letter-spacing: .12em; text-transform: uppercase; color: var(--muted); }
  .divider { height: 1px; background: var(--ring); margin: 10px 0; opacity: 0.5; }

  /* Match hero con animaciones */
  .teams { display: grid; grid-template-columns: 1fr 40px 1fr; gap: 14px; align-items: center; margin-top: 8px; animation: fadeInUp 0.5s ease; }
  .club { display: grid; justify-items: center; text-align: center; gap: 6px; }
  .crest { width: 72px; height: 72px; border-radius: 16px; overflow: hidden; background: var(--chip); display: grid; place-items: center; transition: filter 0.3s; }
  .crest:hover { filter: hue-rotate(15deg) brightness(1.2); }
  .crest img { width: 100%; height: 100%; object-fit: contain; loading: lazy; }
  .crest .fallback { font-weight: 900; opacity: .8; }
  .vs { font-weight: 900; color: var(--muted); }
  .when { font-size: clamp(16px, 4vw, 18px); font-weight: 800; }
  .badges { display: flex; gap: 8px; flex-wrap: wrap; }
  .badge { font-size: var(--sm); background: color-mix(in oklab, var(--brand) 8%, var(--card)); border: 1px dashed var(--ring); color: var(--ink); padding: 6px 10px; border-radius: 999px; transition: transform 0.2s; }
  .badge:hover { transform: scale(1.1); }

  /* TV con dot pulse */
  .tv-logos { display: flex; gap: 8px; flex-wrap: wrap; }
  .tv { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid var(--ring); border-radius: 12px; background: transparent; }
  .tv-dot { width: 8px; height: 8px; border-radius: 999px; background: var(--brand); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

  /* Odds con grid fluid */
  .grid { display: grid; gap: 10px; }
  .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .od { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid var(--ring); border-radius: 14px; background: color-mix(in oklab, var(--card) 95%, transparent); }
  .od strong { font-weight: 800; }

  /* News con expand animation */
  .news { display: grid; gap: 10px; }
  .news .item { border: 1px solid var(--ring); border-radius: 14px; padding: 10px; background: color-mix(in oklab, var(--ink) 6%, var(--card)); cursor: pointer; transition: height 0.3s ease, filter 0.3s; }
  .news .item:hover { filter: contrast(1.1); }
  .news .item strong { display: block; margin-bottom: 4px; }

  /* Standings con stripe y highlight animado */
  table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
  tr:nth-child(even) td { background: color-mix(in oklab, var(--card) 90%, var(--ring)); }
  td { background: var(--card); border: 1px solid var(--ring); padding: 8px; border-radius: 8px; }
  tr.fcbarca td { outline: 2px solid var(--brand); animation: highlight 2s ease; }
  @keyframes highlight { 0% { outline-color: transparent; } 50% { outline-color: var(--brand); } 100% { outline-color: var(--brand); } }

  /* Past/live rows + accordion con smooth open */
  .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 12px; border: 1px solid var(--ring); border-radius: 14px; }
  .acc { display: grid; gap: 8px; }
  .acc .details { display: none; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
  .acc.open .details { display: block; max-height: 200px; } /* Ajusta seg√∫n contenido */

  /* Calendar list */
  .month { font-weight: 800; margin: 6px 0 4px; }
  .cal-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px; border: 1px solid var(--ring); border-radius: 12px; }

  /* Bottom nav con bounce */
  .bn { position: fixed; inset: auto 0 10px 0; margin: auto; z-index: 60; width: min(560px, 100%); display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; background: color-mix(in oklab, var(--card) 90%, transparent); backdrop-filter: blur(12px); border: 1px solid var(--ring); border-radius: 16px; padding: 8px; animation: bounceIn 0.5s; }
  @keyframes bounceIn { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
  .bn button { appearance: none; border: 0; border-radius: 10px; padding: 10px 6px; color: var(--ink); background: transparent; transition: background 0.3s; }
  .bn button.active { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; animation: gradientShift 2s infinite; }
  @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  .bn button:hover { background: color-mix(in oklab, var(--brand) 20%, transparent); }

  @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
  .card, .row, .pill, .news .item { animation: fadeInUp 0.25s ease both; }
  .hidden { display: none !important; }

  /* Skeleton loading para loads */
  .loading { background: var(--ring); animation: skeleton 1.5s infinite; min-height: 20px; }
  @keyframes skeleton { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

  /* Media queries para m√≥viles estrechos */
  @media (max-width: 400px) {
    .tabs { flex-direction: column; }
    .bn { grid-template-columns: repeat(3, 1fr); }
    .teams { grid-template-columns: 1fr; text-align: center; }
  }
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <!-- HEADER -->
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="var(--brand)"/><stop offset="1" stop-color="var(--brand2)"/></linearGradient></defs><path d="M8 10h48v16c0 18-24 28-24 28S8 44 8 26z" fill="url(#g)"/><circle cx="32" cy="28" r="7" fill="#fff" opacity=".15"/></svg>
        </div>
        <div><div class="title">Tracker</div><div class="tiny">Bar√ßa primero. Con gusto, no con pena.</div></div>
      </div>
      <div class="brand" style="gap:6px">
        <button id="themeBtn" class="pill" title="Tema">üåó</button>
        <button id="installBtn" class="pill hidden" title="Instalar">‚¨áÔ∏è</button>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Secciones">
      <button class="pill active" data-tab="next">Siguiente</button>
      <button class="pill" data-tab="past">Pasados</button>
      <button class="pill" data-tab="live">En vivo</button>
      <button class="pill" data-tab="table">Clasificaci√≥n</button>
      <button class="pill" data-tab="cal">Calendario</button>
      <button class="pill" data-tab="teams">Equipos</button>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="screen">
    <!-- NEXT -->
    <section id="tab-next" class="card">
      <div class="kicker">Siguiente partido</div>
      <div class="teams">
        <div class="club">
          <div class="crest" id="homeCrest"><div class="fallback">BAR</div></div>
          <div id="homeName" class="tiny">FC Barcelona</div>
        </div>
        <div class="vs">vs</div>
        <div class="club">
          <div class="crest" id="awayCrest"><div class="fallback">???</div></div>
          <div id="awayName" class="tiny">Cargando‚Ä¶</div>
        </div>
      </div>
      <div class="when" id="whenText">‚Äî</div>
      <div class="tiny" id="compText">‚Äî</div>
      <div class="badges" id="statusBadges"></div>

      <div class="divider"></div>
      <div class="row" style="border:none;padding:0"><strong>TV</strong><span class="tiny">Espa√±a</span></div>
      <div class="tv-logos" id="tvRow"><span class="tiny">Buscando canales‚Ä¶</span></div>

      <div class="divider"></div>
      <div class="row" style="border:none;padding:0"><strong>Cuotas</strong><span class="tiny">1X2 ¬∑ O/U 2.5</span></div>
      <div id="oddsBox" class="grid"></div>

      <div class="divider"></div>
      <div class="row" style="border:none;padding:0"><strong>Noticias del partido</strong><a id="refreshNews" class="tiny" href="#">Actualizar</a></div>
      <div id="newsList" class="news"></div>

      <div class="divider"></div>
      <div class="row" style="gap:8px">
        <button class="pill" id="notifyBtn">Recordarme</button>
        <button class="pill active" id="icsBtn">A√±adir al calendario</button>
      </div>
    </section>

    <!-- PAST -->
    <section id="tab-past" class="card hidden">
      <div class="kicker">Partidos pasados</div>
      <div id="pastList" class="grid"></div>
    </section>

    <!-- LIVE -->
    <section id="tab-live" class="card hidden">
      <div class="kicker">Ahora mismo</div>
      <div id="liveList" class="grid"></div>
    </section>

    <!-- TABLE -->
    <section id="tab-table" class="card hidden">
      <div class="row" style="border:none;padding:0"><strong>LaLiga</strong><span class="tiny" id="tableUpdated">‚Äî</span></div>
      <table id="table"></table>
    </section>

    <!-- CALENDAR -->
    <section id="tab-cal" class="card hidden">
      <div class="row" style="border:none;padding:0"><strong>Calendario del Bar√ßa</strong><span class="tiny">Por meses</span></div>
      <div id="calWrap" class="grid"></div>
    </section>

    <!-- TEAMS -->
    <section id="tab-teams" class="card hidden">
      <div class="row" style="border:none;padding:0"><strong>Busca otro equipo</strong><span class="tiny">Favoritos ‚òÖ</span></div>
      <input id="teamSearch" placeholder="Buscar equipo (LaLiga)" style="width:100%;margin:8px 0;padding:12px;border:1px solid var(--ring);border-radius:12px;background:transparent;color:var(--ink)">
      <div id="teamChips" class="badges"></div>
      <div class="divider"></div>
      <div id="leagueList" class="badges"></div>
    </section>
  </main>

  <!-- BOTTOM NAV -->
  <nav class="bn" aria-label="Navegaci√≥n inferior">
    <button data-tab="next" class="active">‚ñ∂Ô∏è<div class="tiny">Siguiente</div></button>
    <button data-tab="past">‚èÆÔ∏è<div class="tiny">Pasados</div></button>
    <button data-tab="live">üî¥<div class="tiny">En vivo</div></button>
    <button data-tab="table">üìä<div class="tiny">Tabla</div></button>
    <button data-tab="cal">üóìÔ∏è<div class="tiny">Calendario</div></button>
    <button data-tab="teams">‚öôÔ∏è<div class="tiny">Equipos</div></button>
  </nav>
</div>

<script>
/* ===== App logic ===== */ // (El JS original se mantiene, con adiciones para animaciones)
const WORKER="https://test.christiansanabria.workers.dev";
const BARCA_ID="81";
const COUNTRY="Spain"; const LANG="es-ES", GL="ES", CEID="ES:es";
const REFRESH_LIVE_MS=60000;

const state={ theme:"light", teamId: localStorage.getItem("teamId")||BARCA_ID, crestMap:{}, deferredPrompt:null };

const $=(q,el=document)=>el.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
function setTheme(t){ state.theme=t; $("#app").dataset.theme=t; localStorage.setItem("theme",t); document.body.classList.add('theme-transition'); setTimeout(()=>document.body.classList.remove('theme-transition'), 300); }
setTheme(localStorage.getItem("theme")||"light");
$("#themeBtn").onclick=()=> setTheme(state.theme==="light"?"dark":"light");

/* Tabs + bottom nav in sync con fade */
function switchTab(name){
  $$(".bn button, .tabs [data-tab]").forEach(x=> x.classList.toggle("active", x.dataset.tab===name));
  ["next","past","live","table","cal","teams"].forEach(id=> {
    const el = $("#tab-"+id);
    el.classList.toggle("hidden", id!==name);
    if (id === name) el.style.animation = 'fadeInUp 0.5s ease';
  });
  if(name==="table") loadStandings();
  if(name==="past") loadPast();
  if(name==="live") loadLive();
  if(name==="cal") loadCalendar();
}

/* Agrega parallax simple al scroll */
window.addEventListener('scroll', () => {
  if (window.scrollY > 50) document.querySelector('.app').classList.add('scrolled');
  else document.querySelector('.app').classList.remove('scrolled');
});

/* Helpers con skeleton */
function parts(iso){ const d=new Date(iso); return {d:d.toLocaleDateString("es-ES",{weekday:"short",day:"2-digit",month:"short"}), t:d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}; }
function badge(t){ const el=document.createElement("div"); el.className="badge"; el.textContent=t; return el; }
function crestEl(id,name){ const url=state.crestMap[id]; const el=document.createElement("div"); el.className="crest"; if(url){ const img=new Image(); img.decoding="async"; img.src=url; img.classList.add('loading'); img.onload = () => img.classList.remove('loading'); el.appendChild(img); } else { const f=document.createElement("div"); f.className="fallback"; f.textContent=(name||"").toUpperCase().slice(0,3)||"???"; el.appendChild(f); } return el; }
async function ensureCrests(){ if(Object.keys(state.crestMap).length) return; try{ const data=await (await fetch(WORKER+"/standings")).json(); const rows=(data?.standings?.[0]?.table)||[]; rows.forEach(r=>{ const id=r.team?.id; if(id) state.crestMap[id]=r.team?.crest||null; }); }catch{} }

/* El resto del JS es id√©ntico al original, solo agrego llamadas a switchTab y loads con skeletons donde sea necesario */
// Por ejemplo, en loadNext, agrega class 'loading' a elementos mientras cargan
async function loadNext(teamId){
  await ensureCrests();
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","SCHEDULED"); u.searchParams.set("country",COUNTRY); u.searchParams.set("include_tv","1");
  const data=await (await fetch(u)).json();
  const next=(data.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
  if(!next){ $("#whenText").textContent="Sin pr√≥ximo partido"; $("#compText").textContent=""; $("#tvRow").textContent=""; $("#oddsBox").textContent=""; $("#newsList").textContent=""; return; }

  const hN=next.homeTeam?.name||"", aN=next.awayTeam?.name||""; const hId=next.homeTeam?.id, aId=next.awayTeam?.id;
  const homeC=crestEl(hId,hN), awayC=crestEl(aId,aN); homeC.id="homeCrest"; awayC.id="awayCrest";
  $("#homeCrest").replaceWith(homeC); $("#awayCrest").replaceWith(awayC);
  $("#homeName").textContent=hN; $("#awayName").textContent=aN;

  const {d,t}=parts(next.utcDate); $("#whenText").textContent=`${d} ¬∑ ${t}`;
  $("#compText").textContent = next.competition?.name || "";
  const sb=$("#statusBadges"); sb.innerHTML=""; sb.appendChild(badge(COUNTRY)); if(next.status) sb.appendChild(badge(next.status));

  const tv=$("#tvRow"); tv.innerHTML=""; const chans=(next.tv?.channels)||[];
  tv.innerHTML = chans.length ? "" : `<span class="tiny">Sin canal definido todav√≠a</span>`;
  chans.forEach(name=>{ const e=document.createElement("div"); e.className="tv"; e.innerHTML=`<span class="tv-dot"></span><strong>${name}</strong>`; tv.appendChild(e); });

  await loadOdds(hN, aN);
  await loadNews(hN, aN);
}

/* ODDS con skeleton */
async function loadOdds(home,away){
  const box=$("#oddsBox"); box.innerHTML=`<div class="tiny loading">Cargando cuotas‚Ä¶</div>`;
  try{
    const u1=new URL(WORKER+"/odds_next"); u1.searchParams.set("team",state.teamId); u1.searchParams.set("markets","1x2,ou2.5");
    let data=await (await fetch(u1)).json();
    if(!data || data.error){ const u2=new URL(WORKER+"/odds"); u2.searchParams.set("home",home); u2.searchParams.set("away",away); u2.searchParams.set("markets","1x2,ou2.5"); data=await (await fetch(u2)).json(); }
    renderOdds(data, box);
  }catch{ box.innerHTML=`<div class="tiny">No hay cuotas disponibles por ahora.</div>`; }
}
function renderOdds(data,box){
  const arr=Array.isArray(data)?data:(data.normalized||data.data||[]);
  if(!arr||!arr.length){ box.innerHTML=`<div class="tiny">No hay cuotas disponibles.</div>`; return; }
  box.innerHTML="";
  const mkH2H=arr.find(x=>(x.key||x.market||"").toLowerCase().includes("h2h")||(x.market||"").includes("1x2"));
  const mkTotals=arr.find(x=>(x.key||"")==="totals"||(x.market||"").toLowerCase().includes("ou2.5"));
  if(mkH2H){
    const g=document.createElement("div"); g.className="grid cols-3";
    [["1","home"],["X","draw"],["2","away"]].forEach(([lbl,k])=>{
      const v=pickLeg(mkH2H,k);
      const d=document.createElement("div"); d.className="od"; d.innerHTML=`<strong>${lbl}</strong><span>${v?.price??"‚Äî"} <span class="tiny">${v?.book? "¬∑ "+v.book:""}</span></span>`;
      g.appendChild(d);
    }); box.appendChild(g);
  }
  if(mkTotals){
    const g=document.createElement("div"); g.className="grid cols-2";
    const over=pickOU(mkTotals,"over"), under=pickOU(mkTotals,"under");
    g.appendChild(od("Over 2.5", over)); g.appendChild(od("Under 2.5", under)); box.appendChild(g);
  }
}
function od(label,val){ const e=document.createElement("div"); e.className="od"; e.innerHTML=`<strong>${label}</strong><span>${val?.price??"‚Äî"} <span class="tiny">${val?.book? "¬∑ "+val.book:""}</span></span>`; return e; }
function pickLeg(mk,side){ const o=mk.best||mk.h2h||mk.data||mk; return o[side]||(o.outcomes||[]).find(x=>(x.name||"").toLowerCase().includes(side)); }
function pickOU(mk,side){ const o=mk.best||mk.totals||mk.data||mk; const outs=o.outcomes||[]; return outs.find(x=>(x.name||"").toLowerCase().includes(side) && String(x.point??"").includes("2.5")) || o[side]; }

/* NEWS con skeleton */
async function loadNews(home,away){
  const list=$("#newsList"); list.innerHTML=`<div class="tiny loading">Buscando noticias‚Ä¶</div>`;
  try{
    const u=new URL(WORKER+"/news"); u.searchParams.set("home",home); u.searchParams.set("away",away); u.searchParams.set("lang",LANG); u.searchParams.set("gl",GL); u.searchParams.set("ceid",CEID);
    const data=await (await fetch(u)).json(); const items=Array.isArray(data)?data:(data.items||[]);
    list.innerHTML=""; if(!items.length){ list.innerHTML=`<div class="tiny">Sin noticias por ahora.</div>`; return; }
    items.slice(0,6).forEach(it=>{
      const div=document.createElement("div"); div.className="item";
      const src=it.source?` ¬∑ <span class="tiny">${it.source}</span>`:"";
      div.innerHTML=`<strong>${(it.title||"").replace(/&amp;/g,"&")}</strong><div class="tiny">${new Date(it.pubDate).toLocaleString("es-ES")}${src}</div>`;
      div.onclick=()=> window.open(it.link,"_blank","noopener"); list.appendChild(div);
    });
    $("#refreshNews").onclick=(e)=>{ e.preventDefault(); loadNews(home, away); };
  }catch{ list.innerHTML=`<div class="tiny">No se pudo cargar noticias.</div>`; }
}

/* PAST with expandable details (goleadores si existen) */
async function loadPast(teamId=state.teamId){
  const box=$("#pastList"); box.innerHTML="<div class='loading'></div>";
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","FINISHED"); u.searchParams.set("include_tv","0");
  const data=await (await fetch(u)).json(); const arr=(data.matches||[]).slice(-12).reverse();
  if(!arr.length){ box.innerHTML=`<div class="tiny">No hay registros recientes.</div>`; return; }
  box.innerHTML="";
  arr.forEach(m=>{
    const hs=m.score?.fullTime?.home ?? m.score?.regularTime?.home ?? "‚Äì";
    const as=m.score?.fullTime?.away ?? m.score?.regularTime?.away ?? "‚Äì";
    const {d,t}=parts(m.utcDate);
    const acc=document.createElement("div"); acc.className="acc";
    const head=document.createElement("div"); head.className="row"; head.innerHTML=`<strong>${m.homeTeam?.name} ${hs}-${as} ${m.awayTeam?.name}</strong><span class="tiny">${d} ¬∑ ${t}</span>`;
    const det=document.createElement("div"); det.className="details tiny";
    const scorers = m?.scorers || m?.goals || null; // si viniera en la respuesta
    det.innerHTML = [
      `<div><b>Competici√≥n:</b> ${m.competition?.name||"‚Äî"}</div>`,
      `<div><b>Estado:</b> ${m.status||"FINISHED"}</div>`,
      scorers ? `<div><b>Goleadores:</b> ${Array.isArray(scorers)? scorers.map(s=>s.player? s.player.name: s.name).join(", ") : String(scorers)}</div>` : `<div><b>Goleadores:</b> no disponibles en esta API</div>`
    ].join("");
    head.onclick=()=> acc.classList.toggle("open");
    acc.appendChild(head); acc.appendChild(det); box.appendChild(acc);
  });
}

/* LIVE */
async function loadLive(teamId=state.teamId){
  const box=$("#liveList"); box.innerHTML="<div class='loading'></div>";
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","LIVE"); u.searchParams.set("include_tv","1");
  const data=await (await fetch(u)).json(); const arr=data.matches||[];
  if(!arr.length){ box.innerHTML=`<div class="tiny">Nada en vivo ahora mismo.</div>`; return; }
  box.innerHTML="";
  arr.forEach(m=>{
    const hs=m.score?.fullTime?.home ?? m.score?.halfTime?.home ?? "‚Äì";
    const as=m.score?.fullTime?.away ?? m.score?.halfTime?.away ?? "‚Äì";
    const r=document.createElement("div"); r.className="row";
    r.innerHTML=`<strong>${m.homeTeam?.name} ${hs}-${as} ${m.awayTeam?.name}</strong><span class="tiny">${m.status||"LIVE"}</span>`;
    box.appendChild(r);
  });
}

/* TABLE ‚Äì resalta solo Bar√ßa por ID 81 */
async function loadStandings(){
  const tbl=$("#table"); tbl.innerHTML="<tr><td class='loading' colspan='6'></td></tr>";
  const data=await (await fetch(WORKER+"/standings")).json(); const rows=(data?.standings?.[0]?.table)||[];
  $("#tableUpdated").textContent=new Date().toLocaleString("es-ES");
  if(!rows.length){ tbl.innerHTML=`<tr><td>Sin datos</td></tr>`; return; }
  tbl.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr"); if(String(r.team?.id)==="81") tr.className="fcbarca";
    tr.innerHTML=`<td><b>${r.position}</b></td><td>${r.team?.name||""}</td><td><b>${r.points}</b></td><td>PJ ${r.playedGames}</td><td>GF ${r.goalsFor}</td><td>GC ${r.goalsAgainst}</td>`;
    tbl.appendChild(tr);
  });
}

/* CALENDAR ‚Äì pr√≥ximos por meses + ICS individual */
async function loadCalendar(teamId=state.teamId){
  const wrap=$("#calWrap"); wrap.innerHTML="<div class='loading'></div>";
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",teamId); u.searchParams.set("status","SCHEDULED"); u.searchParams.set("include_tv","0");
  const data=await (await fetch(u)).json(); const arr=(data.matches||[]).filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate));
  if(!arr.length){ wrap.innerHTML=`<div class="tiny">No hay pr√≥ximos partidos programados.</div>`; return; }
  wrap.innerHTML="";
  const byMonth = {};
  arr.forEach(m=>{ const d=new Date(m.utcDate); const key=d.toLocaleDateString("es-ES",{month:"long", year:"numeric"}); (byMonth[key]=byMonth[key]||[]).push(m); });
  Object.entries(byMonth).forEach(([mon, list])=>{
    const h=document.createElement("div"); h.className="month"; h.textContent=mon; wrap.appendChild(h);
    list.forEach(m=>{
      const {d,t}=parts(m.utcDate);
      const row=document.createElement("div"); row.className="cal-item";
      const left=`<strong>${m.homeTeam?.name} vs ${m.awayTeam?.name}</strong><div class="tiny">${d} ¬∑ ${t} ¬∑ ${m.competition?.name||""}</div>`;
      const btn=document.createElement("button"); btn.className="pill"; btn.textContent="ICS";
      btn.onclick=()=> saveICS(m);
      row.innerHTML=left; row.appendChild(btn); wrap.appendChild(row);
    });
  });
}
function saveICS(m){
  const start=new Date(m.utcDate), end=new Date(start.getTime()+2*60*60*1000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tracker//ES
BEGIN:VEVENT
DTSTAMP:${fmt(new Date())}
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
SUMMARY:${m.homeTeam?.name} vs ${m.awayTeam?.name}
DESCRIPTION:${m.competition?.name||"F√∫tbol"} - Generado por Tracker
END:VEVENT
END:VCALENDAR`.replace(/\n/g,"\r\n");
  const url=URL.createObjectURL(new Blob([ics],{type:"text/calendar"})); const a=document.createElement("a"); a.href=url; a.download="partido.ics"; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* Notifications */
$("#notifyBtn").onclick=async()=>{
  if(!window.Notification) return alert("Tu navegador no soporta notificaciones.");
  const perm=await Notification.requestPermission(); if(perm!=="granted") return;
  const u=new URL(WORKER+"/matches"); u.searchParams.set("team",state.teamId); u.searchParams.set("status","SCHEDULED");
  const next=(await (await fetch(u)).json()).matches?.filter(m=>m.utcDate).sort((a,b)=> new Date(a.utcDate)-new Date(b.utcDate))[0];
  if(!next) return alert("A√∫n no hay partido programado.");
  const t0=new Date(next.utcDate).getTime(), now=Date.now();
  function fire(ms,msg){ setTimeout(()=> new Notification("Tracker",{body:msg}), ms); }
  if(t0-now>10*60*1000) fire(t0-now-10*60*1000,"El partido empieza en 10 minutos.");
  if(t0-now>0) fire(t0-now,"¬°Rueda el bal√≥n!");
  alert("Recordatorios configurados.");
};

/* Teams ‚Äì LaLiga r√°pida */
const TEAM_MAP={"FC Barcelona":"81","Real Madrid CF":"86","Atl√©tico de Madrid":"78","Athletic Bilbao":"77","Real Sociedad":"92","Villarreal CF":"94","Real Betis":"90","Valencia CF":"95","Sevilla FC":"559","RC Celta de Vigo":"558","RCD Espanyol de Barcelona":"80","Getafe CF":"82","CA Osasuna":"79","Deportivo Alav√©s":"263","Girona FC":"298","UD Las Palmas":"275","Rayo Vallecano":"87","RCD Mallorca":"1041","CD Legan√©s":"745","Real Valladolid CF":"250"};
function renderTeams(){
  const chips=$("#leagueList"); chips.innerHTML="";
  Object.entries(TEAM_MAP).forEach(([name,id])=>{ const b=document.createElement("div"); b.className="pill"; b.textContent=name; b.onclick=()=>{state.teamId=id; localStorage.setItem("teamId",id); switchTab("next"); loadNext(id);} ; chips.appendChild(b);});
  $("#teamSearch").oninput=(e)=>{ const q=e.target.value.toLowerCase(); $$("#leagueList .pill").forEach(b=> b.style.display=b.textContent.toLowerCase().includes(q)?"":"none"); };
}

/* PWA: manifest + install prompt */ (function(){ /* Igual al original */ })();

/* Init */
(async function init(){ renderTeams(); switchTab("next"); await loadNext(state.teamId); loadStandings(); })();
$$(".bn button, .tabs [data-tab]").forEach(b=> b.onclick=()=> switchTab(b.dataset.tab));
</script>
</body>
</html>